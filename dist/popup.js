(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))c(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&c(u)}).observe(document,{childList:!0,subtree:!0});function t(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function c(e){if(e.ep)return;e.ep=!0;const r=t(e);fetch(e.href,r)}})();const q="bookmarks-plus",w="gitee-config";function _(){return new Promise((n,o)=>{const t=indexedDB.open(q,1);t.onupgradeneeded=function(c){const e=c.target.result;e.objectStoreNames.contains(w)||e.createObjectStore(w)},t.onsuccess=function(c){n(c.target.result)},t.onerror=function(c){o(c)}})}function A(n){return _().then(o=>new Promise(t=>{const e=o.transaction(w,"readonly").objectStore(w),r={};let u=n.length;n.forEach(h=>{const m=e.get(h);m.onsuccess=function(){r[h]=m.result||"",u--,u===0&&t(r)},m.onerror=function(){u--,u===0&&t(r)}})}))}function z(n){return _().then(o=>{const t=o.transaction(w,"readwrite"),c=t.objectStore(w);return Object.entries(n).forEach(([e,r])=>c.put(r,e)),new Promise(e=>{t.oncomplete=()=>e(),t.onerror=()=>e()})})}function T(){return A(["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"])}async function K(n){const o=atob(n),c=new TextDecoder().decode(new Uint8Array([...o].map(e=>e.charCodeAt(0))));return JSON.parse(c)}async function J(n,o){return await(await fetch(n,{headers:{Authorization:"token "+o}})).json()}async function H(n,o,t,c){const e={access_token:o,content:t,message:"书签更新",sha:c};(await fetch(n,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"token "+o},body:JSON.stringify(e)})).ok?g("已上传书签数据"):g("上传书签数据失败",!0)}function W(n){let o="";for(const t of n)o+=String.fromCharCode(t);return btoa(o)}async function j(n,o,t){const c=n.giteeToken,e="https://gitee.com/api/v5/repos/"+n.giteeOwner+"/"+n.giteeRepo+"/contents/"+n.giteeFilePath+"?ref="+n.giteeBranch;try{const r=await J(e,c),u=r.content||"";if(!t){const D=await K(u);o=k(D,o)}o=JSON.stringify(o);const m=new TextEncoder().encode(o),P=W(m);await H(e,c,P,r.sha)}catch{g("上传书签数据失败",!0)}}async function G(n){const o=n.giteeToken,t="https://gitee.com/api/v5/repos/"+n.giteeOwner+"/"+n.giteeRepo+"/contents/"+n.giteeFilePath+"?ref="+n.giteeBranch,e=(await J(t,o)).content||"",r=atob(e),h=new TextDecoder().decode(new Uint8Array([...r].map(m=>m.charCodeAt(0))));return JSON.parse(h)}function x(){return new Promise(n=>{chrome.bookmarks.getTree(n)})}function U(){return new Promise(n=>{chrome.bookmarks.getTree(o=>{var r;const t=((r=o[0])==null?void 0:r.children)||[];let c=[];t.forEach(u=>{u.children&&u.children.length&&u.children.forEach(h=>c.push(h.id))});let e=c.length;if(e===0)return n();c.forEach(u=>{chrome.bookmarks.removeTree(u,()=>{e--,e===0&&n()})})})})}function I(n,o="1"){return Promise.all(n.map(t=>t.url?new Promise(c=>{chrome.bookmarks.create({parentId:o,title:t.title,url:t.url},()=>c(void 0))}):new Promise(c=>{chrome.bookmarks.create({parentId:o,title:t.title},e=>{t.children&&t.children.length?I(t.children,e.id).then(()=>c(void 0)):c(void 0)})}))).then(()=>{})}function k(n,o){const t=new Map;function c(e){return e.url?`bookmark:${e.title}|${e.url}`:`folder:${e.title}`}return n.forEach(e=>{const r=c(e);t.set(r,{...e,children:e.children?k(e.children,[]):void 0})}),o.forEach(e=>{const r=c(e);t.has(r)?e.url||t.set(r,{...e,children:k(t.get(r).children||[],e.children||[])}):t.set(r,{...e,children:e.children?k([],e.children):void 0})}),Array.from(t.values())}function g(n,o=!1){const t=document.getElementById("giteeMsg");t&&(t.textContent=n,t.style.color=o?"#f44336":"#42b983",setTimeout(()=>{t&&(t.textContent="")},2e3))}document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("giteeMsg"),o=["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"];A(o).then(s=>{o.forEach(i=>{const a=document.getElementById(i);a&&s[i]&&(a.value=s[i])})}),A(["giteeFilePath"]).then(s=>{const i=s.giteeFilePath;if(i){const a=()=>{Array.from(u.options).find(d=>d.value===i)?u.value=i:setTimeout(a,100)};a()}}),o.forEach(s=>{const i=document.getElementById(s);function a(){const l={};o.forEach(d=>{const f=document.getElementById(d).value;l[d]=f}),z(l).then(()=>{n&&(n.textContent="Gitee 配置已保存！",setTimeout(()=>{n.textContent=""},1200))})}i.addEventListener("blur",a),i.addEventListener("input",a)});const t=document.getElementById("giteeToken"),c=document.getElementById("giteeOwner"),e=document.getElementById("giteeRepo"),r=document.getElementById("giteeBranch"),u=document.getElementById("giteeFilePath"),h=document.getElementById("bookmarkDir");function m(s,i,a="请选择"){s.innerHTML="";const l=document.createElement("option");l.value="",l.textContent=a,s.appendChild(l),i.forEach(d=>{const f=document.createElement("option");f.value=d,f.textContent=d.split("/").pop()||d,s.appendChild(f)})}async function P(s,i,a,l,d){let f=`https://gitee.com/api/v5/repos/${i}/${a}/contents`;d&&(f+=`/${encodeURIComponent(d)}`),f+=`?ref=${l}&access_token=${s}`;const y=await fetch(f);if(!y.ok)throw new Error("获取文件失败");const O=await y.json();return Array.isArray(O)?O.filter(L=>L.type==="file").map(L=>L.path):[]}async function D(s,i,a){const l=`https://gitee.com/api/v5/repos/${i}/${a}/branches?access_token=${s}`,d=await fetch(l);if(!d.ok)throw new Error("获取分支失败");return(await d.json()).map(y=>y.name)}async function S(){const s=t.value.trim(),i=c.value.trim(),a=e.value.trim(),l=r.value,d=h.value.trim();if(!(!s||!i||!a||!l||!d)){m(u,[],"加载中...");try{const y=(await P(s,i,a,l,d)).filter(O=>!O.endsWith(".keep"));m(u,y,"请选择文件")}catch{m(u,[],"获取文件失败")}}}async function F(){const s=t.value.trim(),i=c.value.trim(),a=e.value.trim();if(!(!s||!i||!a)&&!(s===E&&i===v&&a===b)){E=s,v=i,b=a,m(r,[],"加载中...");try{const l=await D(s,i,a);m(r,l,"请选择分支"),l.includes("master")?r.value="master":l.length>0&&(r.value=l[0]),S()}catch{m(r,[],"获取分支失败"),m(u,[],"请先选择分支")}m(u,[],"请先选择分支")}}let E="",v="",b="",M="";function B(){return t.value.trim()!==E||c.value.trim()!==v||e.value.trim()!==b||h.value.trim()!==M}function C(){E=t.value.trim(),v=c.value.trim(),b=e.value.trim(),M=h.value.trim()}t.addEventListener("blur",()=>{B()&&(F(),C())}),c.addEventListener("blur",()=>{B()&&(F(),C())}),e.addEventListener("blur",()=>{B()&&(F(),C())}),h.addEventListener("blur",()=>{B()&&(S(),C())}),setTimeout(()=>{S()},300),document.getElementById("btnSaveOverwrite").onclick=async function(){var s;try{const i=await T(),l=((s=(await x())[0])==null?void 0:s.children)||[];await j(i,l,!0)}catch(i){g("覆盖保存失败: "+i.message,!0)}},document.getElementById("btnSaveMerge").onclick=async function(){var s;try{const i=await T(),l=((s=(await x())[0])==null?void 0:s.children)||[];await j(i,l,!1)}catch(i){g("合并保存失败: "+i.message,!0)}},document.getElementById("btnGetOverwrite").onclick=async function(){try{const s=await T(),i=await G(s);await U(),await I(i[0].children,"1"),g("覆盖获取并替换本地书签成功！")}catch(s){g("覆盖获取失败: "+s.message,!0)}},document.getElementById("btnGetMerge").onclick=async function(){var s;try{const i=await T(),a=await G(i);console.log("arr",a);const l=await x();console.log("tree",l);const d=((s=l[0])==null?void 0:s.children)||[];console.log("local",d);const f=k(d[0].children,a[0].children);console.log("merged",f),await U(),await I(f,"1"),g("合并获取并替换本地书签成功！")}catch(i){g("合并获取失败: "+i.message,!0)}};const $=document.getElementById("openTabBtn");$&&($.onclick=function(){chrome&&chrome.tabs&&chrome.tabs.create?chrome.tabs.create({url:"chrome://bookmarks/"},function(){chrome.runtime.lastError&&alert("无法自动打开书签管理器，请手动访问 chrome://bookmarks/")}):alert("请手动打开 chrome://bookmarks/")});const N=document.getElementById("helpBtn"),p=document.getElementById("helpModal"),R=document.getElementById("helpClose");N&&p&&R&&(N.onclick=()=>{p.style.display="flex"},R.onclick=()=>{p.style.display="none"},p.onclick=s=>{s.target===p&&(p.style.display="none")})});
