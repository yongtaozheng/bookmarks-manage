(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const o of e)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function n(e){const o={};return e.integrity&&(o.integrity=e.integrity),e.referrerPolicy&&(o.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?o.credentials="include":e.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(e){if(e.ep)return;e.ep=!0;const o=n(e);fetch(e.href,o)}})();const z="bookmarks-plus",v="gitee-config";function J(){return new Promise((r,i)=>{const n=indexedDB.open(z,1);n.onupgradeneeded=function(s){const e=s.target.result;e.objectStoreNames.contains(v)||e.createObjectStore(v)},n.onsuccess=function(s){r(s.target.result)},n.onerror=function(s){i(s)}})}function R(r){return J().then(i=>new Promise(n=>{const e=i.transaction(v,"readonly").objectStore(v),o={};let d=r.length;r.forEach(g=>{const h=e.get(g);h.onsuccess=function(){o[g]=h.result||"",d--,d===0&&n(o)},h.onerror=function(){d--,d===0&&n(o)}})}))}function K(r){return J().then(i=>{const n=i.transaction(v,"readwrite"),s=n.objectStore(v);return Object.entries(r).forEach(([e,o])=>s.put(o,e)),new Promise(e=>{n.oncomplete=()=>e(),n.onerror=()=>e()})})}function P(){return R(["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"])}async function H(r){const i=atob(r),s=new TextDecoder().decode(new Uint8Array([...i].map(e=>e.charCodeAt(0))));return JSON.parse(s)}async function q(r,i){return await(await fetch(r,{headers:{Authorization:"token "+i}})).json()}async function W(r,i,n,s){const e={access_token:i,content:n,message:"书签更新",sha:s};(await fetch(r,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"token "+i},body:JSON.stringify(e)})).ok?m("已上传书签数据"):m("上传书签数据失败",!0)}function Q(r){let i="";for(const n of r)i+=String.fromCharCode(n);return btoa(i)}async function U(r,i,n){const s=r.giteeToken,e="https://gitee.com/api/v5/repos/"+r.giteeOwner+"/"+r.giteeRepo+"/contents/"+r.giteeFilePath+"?ref="+r.giteeBranch;try{const o=await q(e,s),d=o.content||"";if(!n){const S=await H(d);i=E(S,i)}i=JSON.stringify(i);const h=new TextEncoder().encode(i),I=Q(h);await W(e,s,I,o.sha)}catch{m("上传书签数据失败",!0)}}async function _(r){const i=r.giteeToken,n="https://gitee.com/api/v5/repos/"+r.giteeOwner+"/"+r.giteeRepo+"/contents/"+r.giteeFilePath+"?ref="+r.giteeBranch,e=(await q(n,i)).content||"",o=atob(e),g=new TextDecoder().decode(new Uint8Array([...o].map(h=>h.charCodeAt(0))));return JSON.parse(g)}function F(){return new Promise(r=>{chrome.bookmarks.getTree(r)})}function G(){return new Promise(r=>{chrome.bookmarks.getTree(i=>{const n=i[0]?.children||[];let s=[];n.forEach(o=>{o.children&&o.children.length&&o.children.forEach(d=>s.push(d.id))});let e=s.length;if(e===0)return r();s.forEach(o=>{chrome.bookmarks.removeTree(o,()=>{e--,e===0&&r()})})})})}function L(r,i="1"){return Promise.all(r.map(n=>n.url?new Promise(s=>{chrome.bookmarks.create({parentId:i,title:n.title,url:n.url},()=>s(void 0))}):new Promise(s=>{chrome.bookmarks.create({parentId:i,title:n.title},e=>{n.children&&n.children.length?L(n.children,e.id).then(()=>s(void 0)):s(void 0)})}))).then(()=>{})}function E(r,i){const n=new Map;function s(e){return e.url?`bookmark:${e.title}|${e.url}`:`folder:${e.title}`}return r.forEach(e=>{const o=s(e);n.set(o,{...e,children:e.children?E(e.children,[]):void 0})}),i.forEach(e=>{const o=s(e);n.has(o)?e.url||n.set(o,{...e,children:E(n.get(o).children||[],e.children||[])}):n.set(o,{...e,children:e.children?E([],e.children):void 0})}),Array.from(n.values())}function m(r,i=!1){const n=document.getElementById("giteeMsg");n&&(n.textContent=r,n.style.color=i?"#f44336":"#42b983",setTimeout(()=>{n&&(n.textContent="")},2e3))}document.addEventListener("DOMContentLoaded",()=>{const r=document.getElementById("giteeMsg"),i=["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"];R(i).then(t=>{i.forEach(c=>{const a=document.getElementById(c);a&&t[c]&&(a.value=t[c])})}),R(["giteeFilePath"]).then(t=>{const c=t.giteeFilePath;if(c){const a=()=>{Array.from(d.options).find(u=>u.value===c)?d.value=c:setTimeout(a,100)};a()}}),i.forEach(t=>{const c=document.getElementById(t);function a(){const l={};i.forEach(u=>{const f=document.getElementById(u).value;l[u]=f}),K(l).then(()=>{r&&(r.textContent="Gitee 配置已保存！",setTimeout(()=>{r.textContent=""},1200))})}c.addEventListener("blur",a),c.addEventListener("input",a)});const n=document.getElementById("giteeToken"),s=document.getElementById("giteeOwner"),e=document.getElementById("giteeRepo"),o=document.getElementById("giteeBranch"),d=document.getElementById("giteeFilePath"),g=document.getElementById("bookmarkDir");function h(t,c,a="请选择"){t.innerHTML="";const l=document.createElement("option");l.value="",l.textContent=a,t.appendChild(l),c.forEach(u=>{const f=document.createElement("option");f.value=u,f.textContent=u.split("/").pop()||u,t.appendChild(f)})}async function I(t,c,a,l,u){let f=`https://gitee.com/api/v5/repos/${c}/${a}/contents`;u&&(f+=`/${encodeURIComponent(u)}`),f+=`?ref=${l}&access_token=${t}`;const p=await fetch(f);if(!p.ok)throw new Error("获取文件失败");const y=await p.json();return Array.isArray(y)?y.filter(k=>k.type==="file").map(k=>k.path):[]}async function S(t,c,a){const l=`https://gitee.com/api/v5/repos/${c}/${a}/branches?access_token=${t}`,u=await fetch(l);if(!u.ok)throw new Error("获取分支失败");return(await u.json()).map(p=>p.name)}async function b(){const t=n.value.trim(),c=s.value.trim(),a=e.value.trim(),l=o.value,u=g.value.trim();if(!(!t||!c||!a||!l||!u)){h(d,[],"加载中...");try{const p=(await I(t,c,a,l,u)).filter(y=>!y.endsWith(".keep"));h(d,p,"请选择文件")}catch{h(d,[],"获取文件失败")}}}async function D(){const t=n.value.trim(),c=s.value.trim(),a=e.value.trim();if(!(!t||!c||!a)&&!(t===B&&c===$&&a===C)){B=t,$=c,C=a,h(o,[],"加载中...");try{const l=await S(t,c,a);h(o,l,"请选择分支"),l.includes("master")?o.value="master":l.length>0&&(o.value=l[0]),b()}catch{h(o,[],"获取分支失败"),h(d,[],"请先选择分支")}h(d,[],"请先选择分支")}}let B="",$="",C="",x="";function O(){return n.value.trim()!==B||s.value.trim()!==$||e.value.trim()!==C||g.value.trim()!==x}function T(){B=n.value.trim(),$=s.value.trim(),C=e.value.trim(),x=g.value.trim()}n.addEventListener("blur",()=>{O()&&(D(),T())}),s.addEventListener("blur",()=>{O()&&(D(),T())}),e.addEventListener("blur",()=>{O()&&(D(),T())}),g.addEventListener("blur",()=>{O()&&(b(),T())}),setTimeout(()=>{b()},300),document.getElementById("btnSaveOverwrite").onclick=async function(){try{const t=await P(),a=(await F())[0]?.children||[];await U(t,a,!0)}catch(t){m("覆盖保存失败: "+t.message,!0)}},document.getElementById("btnSaveMerge").onclick=async function(){try{const t=await P(),a=(await F())[0]?.children||[];await U(t,a,!1)}catch(t){m("合并保存失败: "+t.message,!0)}},document.getElementById("btnGetOverwrite").onclick=async function(){try{const t=await P(),c=await _(t);await G(),await L(c[0].children,"1"),m("覆盖获取并替换本地书签成功！")}catch(t){m("覆盖获取失败: "+t.message,!0)}},document.getElementById("btnGetMerge").onclick=async function(){try{const t=await P(),c=await _(t);console.log("arr",c);const a=await F();console.log("tree",a);const l=a[0]?.children||[];console.log("local",l);const u=E(l[0].children,c[0].children);console.log("merged",u),await G(),await L(u,"1"),m("合并获取并替换本地书签成功！")}catch(t){m("合并获取失败: "+t.message,!0)}},document.getElementById("addBookmarkFile").onclick=async function(){const t=prompt("请输入书签文件名（如：bookmarks.json）：");if(!t)return;const c=n.value.trim(),a=s.value.trim(),l=e.value.trim(),u=o.value,f=g.value.trim();if(!c||!a||!l||!u||!f){m("请先填写完整的配置信息",!0);return}try{const p=f?`${f}/${t}`:t,y=JSON.stringify([],null,2),k=btoa(unescape(encodeURIComponent(y))),M=`https://gitee.com/api/v5/repos/${a}/${l}/contents/${encodeURIComponent(p)}?ref=${u}&access_token=${c}`;(await fetch(M,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:c,content:k,message:`新增书签文件：${t}`,branch:u})})).ok?(m(`新增书签文件成功：${t}`),b()):m("新增书签文件失败",!0)}catch(p){m("新增书签文件失败："+p.message,!0)}},document.getElementById("deleteBookmarkFile").onclick=async function(){const t=d.value;if(!t){m("请先选择要删除的书签文件",!0);return}if(!confirm(`确定要删除书签文件：${t.split("/").pop()} 吗？`))return;const c=n.value.trim(),a=s.value.trim(),l=e.value.trim(),u=o.value;if(!c||!a||!l||!u){m("请先填写完整的配置信息",!0);return}try{const f=`https://gitee.com/api/v5/repos/${a}/${l}/contents/${encodeURIComponent(t)}?ref=${u}&access_token=${c}`,p=await fetch(f);if(!p.ok){m("获取文件信息失败",!0);return}const y=await p.json(),k=`https://gitee.com/api/v5/repos/${a}/${l}/contents/${encodeURIComponent(t)}?ref=${u}&access_token=${c}`;(await fetch(k,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:c,message:`删除书签文件：${t.split("/").pop()}`,sha:y.sha,branch:u})})).ok?(m(`删除书签文件成功：${t.split("/").pop()}`),b()):m("删除书签文件失败",!0)}catch(f){m("删除书签文件失败："+f.message,!0)}},document.getElementById("openGiteeRepo").onclick=function(){const t=s.value.trim(),c=e.value.trim(),a=o.value,l=d.value;if(!t||!c){m("请先填写仓库所有者(owner)和仓库名(repo)",!0);return}if(!l){m("请先选择书签文件",!0);return}let u=`https://gitee.com/${t}/${c}/blob/${a}/${l}`;window.open(u,"_blank")};const A=document.getElementById("openTabBtn");A&&(A.onclick=function(){chrome&&chrome.tabs&&chrome.tabs.create?chrome.tabs.create({url:"chrome://bookmarks/"},function(){chrome.runtime.lastError&&alert("无法自动打开书签管理器，请手动访问 chrome://bookmarks/")}):alert("请手动打开 chrome://bookmarks/")});const N=document.getElementById("helpBtn"),w=document.getElementById("helpModal"),j=document.getElementById("helpClose");N&&w&&j&&(N.onclick=()=>{w.style.display="flex"},j.onclick=()=>{w.style.display="none"},w.onclick=t=>{t.target===w&&(w.style.display="none")})});
