(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const d of r.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function o(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(e){if(e.ep)return;e.ep=!0;const r=o(e);fetch(e.href,r)}})();function K(){return typeof chrome<"u"&&chrome.runtime&&chrome.runtime.sendMessage&&chrome.bookmarks}const H="bookmarks-plus",v="gitee-config";function J(){return new Promise((c,i)=>{const o=indexedDB.open(H,1);o.onupgradeneeded=function(s){const e=s.target.result;e.objectStoreNames.contains(v)||e.createObjectStore(v)},o.onsuccess=function(s){c(s.target.result)},o.onerror=function(s){i(s)}})}function x(c){return J().then(i=>new Promise(o=>{const e=i.transaction(v,"readonly").objectStore(v),r={};let d=c.length;c.forEach(p=>{const h=e.get(p);h.onsuccess=function(){r[p]=h.result||"",d--,d===0&&o(r)},h.onerror=function(){d--,d===0&&o(r)}})}))}function W(c){return J().then(i=>{const o=i.transaction(v,"readwrite"),s=o.objectStore(v);return Object.entries(c).forEach(([e,r])=>s.put(r,e)),new Promise(e=>{o.oncomplete=()=>e(),o.onerror=()=>e()})})}function P(){return x(["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"])}async function Q(c){const i=atob(c),s=new TextDecoder().decode(new Uint8Array([...i].map(e=>e.charCodeAt(0))));return JSON.parse(s)}async function q(c,i){return await(await fetch(c,{headers:{Authorization:"token "+i}})).json()}async function V(c,i,o,s){const e={access_token:i,content:o,message:"书签更新",sha:s};(await fetch(c,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"token "+i},body:JSON.stringify(e)})).ok?m("已上传书签数据"):m("上传书签数据失败",!0)}function X(c){let i="";for(const o of c)i+=String.fromCharCode(o);return btoa(i)}async function U(c,i,o){const s=c.giteeToken,e="https://gitee.com/api/v5/repos/"+c.giteeOwner+"/"+c.giteeRepo+"/contents/"+c.giteeFilePath+"?ref="+c.giteeBranch;try{const r=await q(e,s),d=r.content||"";if(!o){const S=await Q(d);i=b(S,i)}i=JSON.stringify(i);const h=new TextEncoder().encode(i),I=X(h);await V(e,s,I,r.sha)}catch{m("上传书签数据失败",!0)}}async function _(c){const i=c.giteeToken,o="https://gitee.com/api/v5/repos/"+c.giteeOwner+"/"+c.giteeRepo+"/contents/"+c.giteeFilePath+"?ref="+c.giteeBranch,e=(await q(o,i)).content||"",r=atob(e),p=new TextDecoder().decode(new Uint8Array([...r].map(h=>h.charCodeAt(0))));return JSON.parse(p)}function D(){return new Promise(c=>{chrome.bookmarks.getTree(c)})}function G(){return new Promise(c=>{chrome.bookmarks.getTree(i=>{var r;const o=((r=i[0])==null?void 0:r.children)||[];let s=[];o.forEach(d=>{d.children&&d.children.length&&d.children.forEach(p=>s.push(p.id))});let e=s.length;if(e===0)return c();s.forEach(d=>{chrome.bookmarks.removeTree(d,()=>{e--,e===0&&c()})})})})}function L(c,i="1"){return Promise.all(c.map(o=>o.url?new Promise(s=>{chrome.bookmarks.create({parentId:i,title:o.title,url:o.url},()=>s(void 0))}):new Promise(s=>{chrome.bookmarks.create({parentId:i,title:o.title},e=>{o.children&&o.children.length?L(o.children,e.id).then(()=>s(void 0)):s(void 0)})}))).then(()=>{})}function b(c,i){const o=new Map;function s(e){return e.url?`bookmark:${e.title}|${e.url}`:`folder:${e.title}`}return c.forEach(e=>{const r=s(e);o.set(r,{...e,children:e.children?b(e.children,[]):void 0})}),i.forEach(e=>{const r=s(e);o.has(r)?e.url||o.set(r,{...e,children:b(o.get(r).children||[],e.children||[])}):o.set(r,{...e,children:e.children?b([],e.children):void 0})}),Array.from(o.values())}function m(c,i=!1){const o=document.getElementById("giteeMsg");o&&(o.textContent=c,o.style.color=i?"#f44336":"#42b983",setTimeout(()=>{o&&(o.textContent="")},2e3))}document.addEventListener("DOMContentLoaded",()=>{if(!K()){console.warn("Not in Chrome extension context");return}const c=document.getElementById("giteeMsg"),i=["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"];x(i).then(t=>{i.forEach(n=>{const a=document.getElementById(n);a&&t[n]&&(a.value=t[n])})}),x(["giteeFilePath"]).then(t=>{const n=t.giteeFilePath;if(n){const a=()=>{Array.from(d.options).find(u=>u.value===n)?d.value=n:setTimeout(a,100)};a()}}),i.forEach(t=>{const n=document.getElementById(t);function a(){const l={};i.forEach(u=>{const f=document.getElementById(u).value;l[u]=f}),W(l).then(()=>{c&&(c.textContent="Gitee 配置已保存！",setTimeout(()=>{c.textContent=""},1200))})}n.addEventListener("blur",a),n.addEventListener("input",a)});const o=document.getElementById("giteeToken"),s=document.getElementById("giteeOwner"),e=document.getElementById("giteeRepo"),r=document.getElementById("giteeBranch"),d=document.getElementById("giteeFilePath"),p=document.getElementById("bookmarkDir");chrome.runtime.onMessage.addListener(t=>{if(console.log("Popup收到消息:",t),t.type==="updateToken"&&t.token){console.log("准备更新token:",t.token);const n=document.getElementById("giteeToken");n?(console.log("找到token输入框，更新值"),n.value=t.token,n.dispatchEvent(new Event("blur")),m("Token已自动更新")):console.log("未找到token输入框")}return!0}),setTimeout(()=>{console.log("Popup初始化完成，检查是否有待处理的token消息"),chrome.storage.local.get(["latestToken"],t=>{if(t.latestToken){console.log("从storage中读取到最新token:",t.latestToken);const n=document.getElementById("giteeToken");n&&(n.value=t.latestToken,n.dispatchEvent(new Event("blur")),m("Token已自动更新"),chrome.storage.local.remove(["latestToken"]))}})},100);function h(t,n,a="请选择"){t.innerHTML="";const l=document.createElement("option");l.value="",l.textContent=a,t.appendChild(l),n.forEach(u=>{const f=document.createElement("option");f.value=u,f.textContent=u.split("/").pop()||u,t.appendChild(f)})}async function I(t,n,a,l,u){let f=`https://gitee.com/api/v5/repos/${n}/${a}/contents`;u&&(f+=`/${encodeURIComponent(u)}`),f+=`?ref=${l}&access_token=${t}`;const g=await fetch(f);if(!g.ok)throw new Error("获取文件失败");const k=await g.json();return Array.isArray(k)?k.filter(y=>y.type==="file").map(y=>y.path):[]}async function S(t,n,a){const l=`https://gitee.com/api/v5/repos/${n}/${a}/branches?access_token=${t}`,u=await fetch(l);if(!u.ok)throw new Error("获取分支失败");return(await u.json()).map(g=>g.name)}async function E(){const t=o.value.trim(),n=s.value.trim(),a=e.value.trim(),l=r.value,u=p.value.trim();if(!(!t||!n||!a||!l||!u)){h(d,[],"加载中...");try{const g=(await I(t,n,a,l,u)).filter(k=>!k.endsWith(".keep"));h(d,g,"请选择文件")}catch{h(d,[],"获取文件失败")}}}async function F(){const t=o.value.trim(),n=s.value.trim(),a=e.value.trim();if(!(!t||!n||!a)&&!(t===B&&n===T&&a===C)){B=t,T=n,C=a,h(r,[],"加载中...");try{const l=await S(t,n,a);h(r,l,"请选择分支"),l.includes("master")?r.value="master":l.length>0&&(r.value=l[0]),E()}catch{h(r,[],"获取分支失败"),h(d,[],"请先选择分支")}h(d,[],"请先选择分支")}}let B="",T="",C="",R="";function $(){return o.value.trim()!==B||s.value.trim()!==T||e.value.trim()!==C||p.value.trim()!==R}function O(){B=o.value.trim(),T=s.value.trim(),C=e.value.trim(),R=p.value.trim()}o.addEventListener("blur",()=>{$()&&(F(),O())}),s.addEventListener("blur",()=>{$()&&(F(),O())}),e.addEventListener("blur",()=>{$()&&(F(),O())}),p.addEventListener("blur",()=>{$()&&(E(),O())}),setTimeout(()=>{E()},300),document.getElementById("btnSaveOverwrite").onclick=async function(){var t;if(confirm("确定要覆盖保存到Gitee吗？这将覆盖远程仓库中的书签数据。"))try{const n=await P(),l=((t=(await D())[0])==null?void 0:t.children)||[];await U(n,l,!0),m("覆盖保存成功！")}catch(n){m("覆盖保存失败: "+n.message,!0)}},document.getElementById("btnSaveMerge").onclick=async function(){var t;if(confirm("确定要合并保存到Gitee吗？这将把本地书签与远程书签合并后保存。"))try{const n=await P(),l=((t=(await D())[0])==null?void 0:t.children)||[];await U(n,l,!1),m("合并保存成功！")}catch(n){m("合并保存失败: "+n.message,!0)}},document.getElementById("btnGetOverwrite").onclick=async function(){if(confirm("确定要覆盖获取吗？这将用远程书签完全替换本地书签数据，本地书签将被删除。"))try{const t=await P(),n=await _(t);await G(),await L(n[0].children,"1"),m("覆盖获取并替换本地书签成功！")}catch(t){m("覆盖获取失败: "+t.message,!0)}},document.getElementById("btnGetMerge").onclick=async function(){var t;if(confirm("确定要合并获取吗？这将把远程书签与本地书签合并后替换本地数据。"))try{const n=await P(),a=await _(n);console.log("arr",a);const l=await D();console.log("tree",l);const u=((t=l[0])==null?void 0:t.children)||[];console.log("local",u);const f=b(u[0].children,a[0].children);console.log("merged",f),await G(),await L(f,"1"),m("合并获取并替换本地书签成功！")}catch(n){m("合并获取失败: "+n.message,!0)}},document.getElementById("addBookmarkFile").onclick=async function(){const t=prompt("请输入书签文件名（如：bookmarks.json）：");if(!t)return;const n=t.includes(".")?t:`${t}.json`,a=o.value.trim(),l=s.value.trim(),u=e.value.trim(),f=r.value,g=p.value.trim();if(!a||!l||!u||!f||!g){m("请先填写完整的配置信息",!0);return}try{const k=g?`${g}/${n}`:n,y=JSON.stringify([],null,2),A=btoa(unescape(encodeURIComponent(y))),z=`https://gitee.com/api/v5/repos/${l}/${u}/contents/${encodeURIComponent(k)}?ref=${f}&access_token=${a}`;(await fetch(z,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:a,content:A,message:`新增书签文件：${n}`,branch:f})})).ok?(m(`新增书签文件成功：${n}`),E()):m("新增书签文件失败",!0)}catch(k){m("新增书签文件失败："+k.message,!0)}},document.getElementById("deleteBookmarkFile").onclick=async function(){const t=d.value;if(!t){m("请先选择要删除的书签文件",!0);return}if(!confirm(`确定要删除书签文件：${t.split("/").pop()} 吗？`))return;const n=o.value.trim(),a=s.value.trim(),l=e.value.trim(),u=r.value;if(!n||!a||!l||!u){m("请先填写完整的配置信息",!0);return}try{const f=`https://gitee.com/api/v5/repos/${a}/${l}/contents/${encodeURIComponent(t)}?ref=${u}&access_token=${n}`,g=await fetch(f);if(!g.ok){m("获取文件信息失败",!0);return}const k=await g.json(),y=`https://gitee.com/api/v5/repos/${a}/${l}/contents/${encodeURIComponent(t)}?ref=${u}&access_token=${n}`;(await fetch(y,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:n,message:`删除书签文件：${t.split("/").pop()}`,sha:k.sha,branch:u})})).ok?(m(`删除书签文件成功：${t.split("/").pop()}`),E()):m("删除书签文件失败",!0)}catch(f){m("删除书签文件失败："+f.message,!0)}},document.getElementById("openGiteeRepo").onclick=function(){const t=s.value.trim(),n=e.value.trim(),a=r.value,l=d.value;if(!t||!n){m("请先填写仓库所有者(owner)和仓库名(repo)",!0);return}if(!l){m("请先选择书签文件",!0);return}let u=`https://gitee.com/${t}/${n}/blob/${a}/${l}`;window.open(u,"_blank")};const N=document.getElementById("openTabBtn");N&&(N.onclick=function(){chrome&&chrome.tabs&&chrome.tabs.create?chrome.tabs.create({url:"chrome://bookmarks/"},function(){chrome.runtime.lastError&&alert("无法自动打开书签管理器，请手动访问 chrome://bookmarks/")}):alert("请手动打开 chrome://bookmarks/")});const M=document.getElementById("helpBtn"),w=document.getElementById("helpModal"),j=document.getElementById("helpClose");M&&w&&j&&(M.onclick=()=>{w.style.display="flex"},j.onclick=()=>{w.style.display="none"},w.onclick=t=>{t.target===w&&(w.style.display="none")})});
