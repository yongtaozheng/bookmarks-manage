(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))i(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function t(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(e){if(e.ep)return;e.ep=!0;const r=t(e);fetch(e.href,r)}})();const C="bookmarks-plus",f="gitee-config";function E(){return new Promise((n,o)=>{const t=indexedDB.open(C,1);t.onupgradeneeded=function(i){const e=i.target.result;e.objectStoreNames.contains(f)||e.createObjectStore(f)},t.onsuccess=function(i){n(i.target.result)},t.onerror=function(i){o(i)}})}function B(n){return E().then(o=>new Promise(t=>{const e=o.transaction(f,"readonly").objectStore(f),r={};let c=n.length;n.forEach(s=>{const a=e.get(s);a.onsuccess=function(){r[s]=a.result||"",c--,c===0&&t(r)},a.onerror=function(){c--,c===0&&t(r)}})}))}function O(n){return E().then(o=>{const t=o.transaction(f,"readwrite"),i=t.objectStore(f);return Object.entries(n).forEach(([e,r])=>i.put(r,e)),new Promise(e=>{t.oncomplete=()=>e(),t.onerror=()=>e()})})}function g(){return B(["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"])}async function T(n){const o=atob(n),i=new TextDecoder().decode(new Uint8Array([...o].map(e=>e.charCodeAt(0))));return JSON.parse(i)}async function v(n,o){return await(await fetch(n,{headers:{Authorization:"token "+o}})).json()}async function P(n,o,t,i){const e={access_token:o,content:t,message:"书签更新",sha:i};(await fetch(n,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"token "+o},body:JSON.stringify(e)})).ok?d("已上传书签数据"):d("上传书签数据失败",!0)}function D(n){let o="";for(const t of n)o+=String.fromCharCode(t);return btoa(o)}async function w(n,o,t){const i=n.giteeToken,e="https://gitee.com/api/v5/repos/"+n.giteeOwner+"/"+n.giteeRepo+"/contents/"+n.giteeFilePath+"?ref="+n.giteeBranch;try{const r=await v(e,i),c=r.content||"";if(!t){const u=await T(c);o=m(u,o)}o=JSON.stringify(o);const a=new TextEncoder().encode(o),l=D(a);await P(e,i,l,r.sha)}catch{d("上传书签数据失败",!0)}}async function k(n){const o=n.giteeToken,t="https://gitee.com/api/v5/repos/"+n.giteeOwner+"/"+n.giteeRepo+"/contents/"+n.giteeFilePath+"?ref="+n.giteeBranch,e=(await v(t,o)).content||"",r=atob(e),s=new TextDecoder().decode(new Uint8Array([...r].map(a=>a.charCodeAt(0))));return JSON.parse(s)}function p(){return new Promise(n=>{chrome.bookmarks.getTree(n)})}function b(){return new Promise(n=>{chrome.bookmarks.getTree(o=>{var r;const t=((r=o[0])==null?void 0:r.children)||[];let i=[];t.forEach(c=>{c.children&&c.children.length&&c.children.forEach(s=>i.push(s.id))});let e=i.length;if(e===0)return n();i.forEach(c=>{chrome.bookmarks.removeTree(c,()=>{e--,e===0&&n()})})})})}function y(n,o="1"){return Promise.all(n.map(t=>t.url?new Promise(i=>{chrome.bookmarks.create({parentId:o,title:t.title,url:t.url},()=>i(void 0))}):new Promise(i=>{chrome.bookmarks.create({parentId:o,title:t.title},e=>{t.children&&t.children.length?y(t.children,e.id).then(()=>i(void 0)):i(void 0)})}))).then(()=>{})}function m(n,o){const t=new Map;function i(e){return e.url?`bookmark:${e.title}|${e.url}`:`folder:${e.title}`}return n.forEach(e=>{const r=i(e);t.set(r,{...e,children:e.children?m(e.children,[]):void 0})}),o.forEach(e=>{const r=i(e);t.has(r)?e.url||t.set(r,{...e,children:m(t.get(r).children||[],e.children||[])}):t.set(r,{...e,children:e.children?m([],e.children):void 0})}),Array.from(t.values())}function d(n,o=!1){const t=document.getElementById("giteeMsg");t&&(t.textContent=n,t.style.color=o?"#f44336":"#42b983",setTimeout(()=>{t&&(t.textContent="")},2e3))}document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("giteeMsg"),o=["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"];B(o).then(c=>{o.forEach(s=>{const a=document.getElementById(s);a&&c[s]&&(a.value=c[s])})}),o.forEach(c=>{const s=document.getElementById(c);function a(){const l={};o.forEach(u=>{const h=document.getElementById(u).value;l[u]=h}),O(l).then(()=>{n&&(n.textContent="Gitee 配置已保存！",setTimeout(()=>{n.textContent=""},1200))})}s.addEventListener("blur",a),s.addEventListener("input",a)}),document.getElementById("btnSaveOverwrite").onclick=async function(){var c;try{const s=await g(),l=((c=(await p())[0])==null?void 0:c.children)||[];await w(s,l,!0)}catch(s){d("覆盖保存失败: "+s.message,!0)}},document.getElementById("btnSaveMerge").onclick=async function(){var c;try{const s=await g(),l=((c=(await p())[0])==null?void 0:c.children)||[];await w(s,l,!1)}catch(s){d("合并保存失败: "+s.message,!0)}},document.getElementById("btnGetOverwrite").onclick=async function(){try{const c=await g(),s=await k(c);await b(),await y(s[0].children,"1"),d("覆盖获取并替换本地书签成功！")}catch(c){d("覆盖获取失败: "+c.message,!0)}},document.getElementById("btnGetMerge").onclick=async function(){var c;try{const s=await g(),a=await k(s);console.log("arr",a);const l=await p();console.log("tree",l);const u=((c=l[0])==null?void 0:c.children)||[];console.log("local",u);const h=m(u[0].children,a[0].children);console.log("merged",h),await b(),await y(h,"1"),d("合并获取并替换本地书签成功！")}catch(s){d("合并获取失败: "+s.message,!0)}};const t=document.getElementById("openTabBtn");t&&(t.onclick=function(){chrome&&chrome.tabs&&chrome.tabs.create?chrome.tabs.create({url:"chrome://bookmarks/"},function(){chrome.runtime.lastError&&alert("无法自动打开书签管理器，请手动访问 chrome://bookmarks/")}):alert("请手动打开 chrome://bookmarks/")});const i=document.getElementById("helpBtn"),e=document.getElementById("helpModal"),r=document.getElementById("helpClose");i&&e&&r&&(i.onclick=()=>{e.style.display="flex"},r.onclick=()=>{e.style.display="none"},e.onclick=c=>{c.target===e&&(e.style.display="none")})});
