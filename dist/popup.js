(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))i(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function t(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(e){if(e.ep)return;e.ep=!0;const r=t(e);fetch(e.href,r)}})();const C="bookmarks-plus",f="gitee-config";function b(){return new Promise((n,o)=>{const t=indexedDB.open(C,1);t.onupgradeneeded=function(i){const e=i.target.result;e.objectStoreNames.contains(f)||e.createObjectStore(f)},t.onsuccess=function(i){n(i.target.result)},t.onerror=function(i){o(i)}})}function E(n){return b().then(o=>new Promise(t=>{const e=o.transaction(f,"readonly").objectStore(f),r={};let c=n.length;n.forEach(a=>{const s=e.get(a);s.onsuccess=function(){r[a]=s.result||"",c--,c===0&&t(r)},s.onerror=function(){c--,c===0&&t(r)}})}))}function O(n){return b().then(o=>{const t=o.transaction(f,"readwrite"),i=t.objectStore(f);return Object.entries(n).forEach(([e,r])=>i.put(r,e)),new Promise(e=>{t.oncomplete=()=>e(),t.onerror=()=>e()})})}function h(){return E(["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"])}async function T(n){const o=atob(n),i=new TextDecoder().decode(new Uint8Array([...o].map(e=>e.charCodeAt(0))));return JSON.parse(i)}async function B(n,o){return await(await fetch(n,{headers:{Authorization:"token "+o}})).json()}async function P(n,o,t,i){const e={access_token:o,content:t,message:"书签更新",sha:i};(await fetch(n,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"token "+o},body:JSON.stringify(e)})).ok?l("已上传书签数据"):l("上传书签数据失败",!0)}function D(n){let o="";for(const t of n)o+=String.fromCharCode(t);return btoa(o)}async function y(n,o,t){const i=n.giteeToken,e="https://gitee.com/api/v5/repos/"+n.giteeOwner+"/"+n.giteeRepo+"/contents/"+n.giteeFilePath+"?ref="+n.giteeBranch;try{const r=await B(e,i),c=r.content||"";if(!t){const u=await T(c);o=m(u,o)}o=JSON.stringify(o);const s=new TextEncoder().encode(o),d=D(s);await P(e,i,d,r.sha)}catch{l("上传书签数据失败",!0)}}async function w(n){const o=n.giteeToken,t="https://gitee.com/api/v5/repos/"+n.giteeOwner+"/"+n.giteeRepo+"/contents/"+n.giteeFilePath+"?ref="+n.giteeBranch,e=(await B(t,o)).content||"",r=atob(e),a=new TextDecoder().decode(new Uint8Array([...r].map(s=>s.charCodeAt(0))));return JSON.parse(a)}function g(){return new Promise(n=>{chrome.bookmarks.getTree(n)})}function k(){return new Promise(n=>{chrome.bookmarks.getTree(o=>{const t=o[0]?.children||[];let i=[];t.forEach(r=>{r.children&&r.children.length&&r.children.forEach(c=>i.push(c.id))});let e=i.length;if(e===0)return n();i.forEach(r=>{chrome.bookmarks.removeTree(r,()=>{e--,e===0&&n()})})})})}function p(n,o="1"){return Promise.all(n.map(t=>t.url?new Promise(i=>{chrome.bookmarks.create({parentId:o,title:t.title,url:t.url},()=>i(void 0))}):new Promise(i=>{chrome.bookmarks.create({parentId:o,title:t.title},e=>{t.children&&t.children.length?p(t.children,e.id).then(()=>i(void 0)):i(void 0)})}))).then(()=>{})}function m(n,o){const t=new Map;function i(e){return e.url?`bookmark:${e.title}|${e.url}`:`folder:${e.title}`}return n.forEach(e=>{const r=i(e);t.set(r,{...e,children:e.children?m(e.children,[]):void 0})}),o.forEach(e=>{const r=i(e);t.has(r)?e.url||t.set(r,{...e,children:m(t.get(r).children||[],e.children||[])}):t.set(r,{...e,children:e.children?m([],e.children):void 0})}),Array.from(t.values())}function l(n,o=!1){const t=document.getElementById("giteeMsg");t&&(t.textContent=n,t.style.color=o?"#f44336":"#42b983",setTimeout(()=>{t&&(t.textContent="")},2e3))}document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("giteeMsg"),o=["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"];E(o).then(c=>{o.forEach(a=>{const s=document.getElementById(a);s&&c[a]&&(s.value=c[a])})}),o.forEach(c=>{const a=document.getElementById(c);function s(){const d={};o.forEach(u=>{const v=document.getElementById(u).value;d[u]=v}),O(d).then(()=>{n&&(n.textContent="Gitee 配置已保存！",setTimeout(()=>{n.textContent=""},1200))})}a.addEventListener("blur",s),a.addEventListener("input",s)}),document.getElementById("btnSaveOverwrite").onclick=async function(){try{const c=await h(),s=(await g())[0]?.children||[];await y(c,s,!0)}catch(c){l("覆盖保存失败: "+c.message,!0)}},document.getElementById("btnSaveMerge").onclick=async function(){try{const c=await h(),s=(await g())[0]?.children||[];await y(c,s,!1)}catch(c){l("合并保存失败: "+c.message,!0)}},document.getElementById("btnGetOverwrite").onclick=async function(){try{const c=await h(),a=await w(c);await k(),await p(a[0].children,"1"),l("覆盖获取并替换本地书签成功！")}catch(c){l("覆盖获取失败: "+c.message,!0)}},document.getElementById("btnGetMerge").onclick=async function(){try{const c=await h(),a=await w(c);console.log("arr",a);const s=await g();console.log("tree",s);const d=s[0]?.children||[];console.log("local",d);const u=m(d[0].children,a[0].children);console.log("merged",u),await k(),await p(u,"1"),l("合并获取并替换本地书签成功！")}catch(c){l("合并获取失败: "+c.message,!0)}};const t=document.getElementById("openTabBtn");t&&(t.onclick=function(){chrome&&chrome.tabs&&chrome.tabs.create?chrome.tabs.create({url:"chrome://bookmarks/"},function(){chrome.runtime.lastError&&alert("无法自动打开书签管理器，请手动访问 chrome://bookmarks/")}):alert("请手动打开 chrome://bookmarks/")});const i=document.getElementById("helpBtn"),e=document.getElementById("helpModal"),r=document.getElementById("helpClose");i&&e&&r&&(i.onclick=()=>{e.style.display="flex"},r.onclick=()=>{e.style.display="none"},e.onclick=c=>{c.target===e&&(e.style.display="none")})});
