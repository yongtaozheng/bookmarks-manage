(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))a(e);new MutationObserver(e=>{for(const i of e)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function o(e){const i={};return e.integrity&&(i.integrity=e.integrity),e.referrerPolicy&&(i.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?i.credentials="include":e.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(e){if(e.ep)return;e.ep=!0;const i=o(e);fetch(e.href,i)}})();function K(){return typeof chrome<"u"&&chrome.runtime&&chrome.runtime.sendMessage&&chrome.bookmarks}const W="bookmarks-plus",v="gitee-config";function H(){return new Promise((r,c)=>{const o=indexedDB.open(W,1);o.onupgradeneeded=function(a){const e=a.target.result;e.objectStoreNames.contains(v)||e.createObjectStore(v)},o.onsuccess=function(a){r(a.target.result)},o.onerror=function(a){c(a)}})}function R(r){return H().then(c=>new Promise(o=>{const e=c.transaction(v,"readonly").objectStore(v),i={};let d=r.length;r.forEach(k=>{const p=e.get(k);p.onsuccess=function(){i[k]=p.result||"",d--,d===0&&o(i)},p.onerror=function(){d--,d===0&&o(i)}})}))}function Q(r){return H().then(c=>{const o=c.transaction(v,"readwrite"),a=o.objectStore(v);return Object.entries(r).forEach(([e,i])=>a.put(i,e)),new Promise(e=>{o.oncomplete=()=>e(),o.onerror=()=>e()})})}function S(){return R(["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"])}async function V(r){const c=atob(r),a=new TextDecoder().decode(new Uint8Array([...c].map(e=>e.charCodeAt(0))));return JSON.parse(a)}async function z(r,c){return await(await fetch(r,{headers:{Authorization:"token "+c}})).json()}async function X(r,c,o,a){const e={access_token:c,content:o,message:"书签更新",sha:a};(await fetch(r,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"token "+c},body:JSON.stringify(e)})).ok?m("已上传书签数据"):m("上传书签数据失败",!0)}function Y(r){let c="";for(const o of r)c+=String.fromCharCode(o);return btoa(c)}async function G(r,c,o){const a=r.giteeToken,e="https://gitee.com/api/v5/repos/"+r.giteeOwner+"/"+r.giteeRepo+"/contents/"+r.giteeFilePath+"?ref="+r.giteeBranch;try{const i=await z(e,a),d=i.content||"";if(!o){const M=await V(d);c=E(M,c)}c=JSON.stringify(c);const p=new TextEncoder().encode(c),D=Y(p);await X(e,a,D,i.sha)}catch{m("上传书签数据失败",!0)}}async function J(r){const c=r.giteeToken,o="https://gitee.com/api/v5/repos/"+r.giteeOwner+"/"+r.giteeRepo+"/contents/"+r.giteeFilePath+"?ref="+r.giteeBranch,e=(await z(o,c)).content||"",i=atob(e),k=new TextDecoder().decode(new Uint8Array([...i].map(p=>p.charCodeAt(0))));return JSON.parse(k)}function L(){return new Promise(r=>{chrome.bookmarks.getTree(r)})}function Z(){return new Promise(r=>{chrome.runtime.sendMessage({type:"getBookmarkManagerData"},c=>{if(chrome.runtime.lastError){r([]);return}r((c==null?void 0:c.bookmarks)||[])})})}function q(){return new Promise(r=>{chrome.bookmarks.getTree(c=>{var i;const o=((i=c[0])==null?void 0:i.children)||[];let a=[];o.forEach(d=>{d.children&&d.children.length&&d.children.forEach(k=>a.push(k.id))});let e=a.length;if(e===0)return r();a.forEach(d=>{chrome.bookmarks.removeTree(d,()=>{e--,e===0&&r()})})})})}function A(r,c="1"){return Promise.all(r.map(o=>o.url?new Promise(a=>{chrome.bookmarks.create({parentId:c,title:o.title,url:o.url},()=>a(void 0))}):new Promise(a=>{chrome.bookmarks.create({parentId:c,title:o.title},e=>{o.children&&o.children.length?A(o.children,e.id).then(()=>a(void 0)):a(void 0)})}))).then(()=>{})}function ee(r){const c=o=>{const a=[];return o.forEach(e=>{if(e.hidden)a.push(e);else if(e.children&&e.children.length>0){const i=c(e.children);i.length>0&&a.push({...e,children:i})}}),a};return c(r)}function E(r,c){const o=new Map;function a(e){return e.url?`bookmark:${e.title}|${e.url}`:`folder:${e.title}`}return r.forEach(e=>{const i=a(e);o.set(i,{...e,children:e.children?E(e.children,[]):void 0})}),c.forEach(e=>{const i=a(e);o.has(i)?e.url||o.set(i,{...e,children:E(o.get(i).children||[],e.children||[])}):o.set(i,{...e,children:e.children?E([],e.children):void 0})}),Array.from(o.values())}function m(r,c=!1){const o=document.getElementById("giteeMsg");o&&(o.textContent=r,o.style.color=c?"#f44336":"#42b983",setTimeout(()=>{o&&(o.textContent="")},2e3))}document.addEventListener("DOMContentLoaded",()=>{if(!K())return;const r=document.getElementById("giteeMsg"),c=["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"];R(c).then(n=>{c.forEach(t=>{const s=document.getElementById(t);s&&n[t]&&(s.value=n[t])})}),R(["giteeFilePath"]).then(n=>{const t=n.giteeFilePath;if(t){const s=()=>{Array.from(d.options).find(u=>u.value===t)?d.value=t:setTimeout(s,100)};s()}}),c.forEach(n=>{const t=document.getElementById(n);function s(){const l={};c.forEach(u=>{const f=document.getElementById(u).value;l[u]=f}),Q(l).then(()=>{r&&(r.textContent="Gitee 配置已保存！",setTimeout(()=>{r.textContent=""},1200))})}t.addEventListener("blur",s),t.addEventListener("input",s)});const o=document.getElementById("giteeToken"),a=document.getElementById("giteeOwner"),e=document.getElementById("giteeRepo"),i=document.getElementById("giteeBranch"),d=document.getElementById("giteeFilePath"),k=document.getElementById("bookmarkDir");chrome.runtime.onMessage.addListener(n=>{if(n.type==="updateToken"&&n.token){const t=document.getElementById("giteeToken");t&&(t.value=n.token,t.dispatchEvent(new Event("blur")),m("Token已自动更新"))}return!0}),setTimeout(()=>{chrome.storage.local.get(["latestToken"],n=>{if(n.latestToken){const t=document.getElementById("giteeToken");t&&(t.value=n.latestToken,t.dispatchEvent(new Event("blur")),m("Token已自动更新"),chrome.storage.local.remove(["latestToken"]))}})},100);function p(n,t,s="请选择"){n.innerHTML="";const l=document.createElement("option");l.value="",l.textContent=s,n.appendChild(l),t.forEach(u=>{const f=document.createElement("option");f.value=u,f.textContent=u.split("/").pop()||u,n.appendChild(f)})}async function D(n,t,s,l,u){let f=`https://gitee.com/api/v5/repos/${t}/${s}/contents`;u&&(f+=`/${encodeURIComponent(u)}`),f+=`?ref=${l}&access_token=${n}`;const h=await fetch(f);if(!h.ok)throw new Error("获取文件失败");const g=await h.json();return Array.isArray(g)?g.filter(y=>y.type==="file").map(y=>y.path):[]}async function M(n,t,s){const l=`https://gitee.com/api/v5/repos/${t}/${s}/branches?access_token=${n}`,u=await fetch(l);if(!u.ok)throw new Error("获取分支失败");return(await u.json()).map(h=>h.name)}async function b(){const n=o.value.trim(),t=a.value.trim(),s=e.value.trim(),l=i.value,u=k.value.trim();if(!(!n||!t||!s||!l||!u)){p(d,[],"加载中...");try{const h=(await D(n,t,s,l,u)).filter(g=>!g.endsWith(".keep"));p(d,h,"请选择文件")}catch{p(d,[],"获取文件失败")}}}async function F(){const n=o.value.trim(),t=a.value.trim(),s=e.value.trim();if(!(!n||!t||!s)&&!(n===B&&t===C&&s===$)){B=n,C=t,$=s,p(i,[],"加载中...");try{const l=await M(n,t,s);p(i,l,"请选择分支"),l.includes("master")?i.value="master":l.length>0&&(i.value=l[0]),b()}catch{p(i,[],"获取分支失败"),p(d,[],"请先选择分支")}p(d,[],"请先选择分支")}}let B="",C="",$="",x="";function T(){return o.value.trim()!==B||a.value.trim()!==C||e.value.trim()!==$||k.value.trim()!==x}function O(){B=o.value.trim(),C=a.value.trim(),$=e.value.trim(),x=k.value.trim()}o.addEventListener("blur",()=>{T()&&(F(),O())}),a.addEventListener("blur",()=>{T()&&(F(),O())}),e.addEventListener("blur",()=>{T()&&(F(),O())}),k.addEventListener("blur",()=>{T()&&(b(),O())}),setTimeout(()=>{b()},300),document.getElementById("btnSaveOverwrite").onclick=async function(){var t;if(!confirm("确定要覆盖保存到Gitee吗？这将覆盖远程仓库中的书签数据。"))return;const n=confirm(`是否保留远程仓库中的隐藏书签？

点击"确定"：保留远程隐藏书签并合并到本地书签
点击"取消"：直接使用本地书签覆盖远程仓库`);try{const s=await S();let u=((t=(await L())[0])==null?void 0:t.children)||[];if(n)try{const f=await Z();if(f&&f.length>0){const h=ee(f);u=E(u,h),m("已保留书签管理器中的隐藏书签并合并到保存内容中")}else m("无法获取书签管理器数据，将直接使用当前书签覆盖",!0)}catch{m("获取书签管理器数据失败，将直接使用当前书签覆盖",!0)}await G(s,u,!0),m("覆盖保存成功！")}catch(s){m("覆盖保存失败: "+s.message,!0)}},document.getElementById("btnSaveMerge").onclick=async function(){var n;if(confirm("确定要合并保存到Gitee吗？这将把本地书签与远程书签合并后保存。"))try{const t=await S(),l=((n=(await L())[0])==null?void 0:n.children)||[];await G(t,l,!1),m("合并保存成功！")}catch(t){m("合并保存失败: "+t.message,!0)}},document.getElementById("btnGetOverwrite").onclick=async function(){var n;if(confirm("确定要覆盖获取吗？这将用远程书签完全替换本地书签数据，本地书签将被删除。"))try{const t=await S(),s=await J(t);let l;if(Array.isArray(s))l=((n=s[0])==null?void 0:n.children)||[];else if(s.children)l=s.children;else throw new Error("远程书签数据格式不正确");await q(),await A(l,"1"),m("覆盖获取并替换本地书签成功！")}catch(t){m("覆盖获取失败: "+t.message,!0)}},document.getElementById("btnGetMerge").onclick=async function(){var n,t;if(confirm("确定要合并获取吗？这将把远程书签与本地书签合并后替换本地数据。"))try{const s=await S(),l=await J(s),f=((n=(await L())[0])==null?void 0:n.children)||[];let h;if(Array.isArray(l))h=((t=l[0])==null?void 0:t.children)||[];else if(l.children)h=l.children;else throw new Error("远程书签数据格式不正确");const g=f.find(I=>I.title==="书签栏"||I.title==="Bookmarks bar"),y=(g==null?void 0:g.children)||[],P=E(y,h);await q(),await A(P,"1"),m("合并获取并替换本地书签成功！")}catch(s){m("合并获取失败: "+s.message,!0)}},document.getElementById("addBookmarkFile").onclick=async function(){const n=prompt("请输入书签文件名（如：bookmarks.json）：");if(!n)return;const t=n.includes(".")?n:`${n}.json`,s=o.value.trim(),l=a.value.trim(),u=e.value.trim(),f=i.value,h=k.value.trim();if(!s||!l||!u||!f||!h){m("请先填写完整的配置信息",!0);return}try{const g=h?`${h}/${t}`:t,y=JSON.stringify([],null,2),P=btoa(unescape(encodeURIComponent(y))),I=`https://gitee.com/api/v5/repos/${l}/${u}/contents/${encodeURIComponent(g)}?ref=${f}&access_token=${s}`;(await fetch(I,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:s,content:P,message:`新增书签文件：${t}`,branch:f})})).ok?(m(`新增书签文件成功：${t}`),b()):m("新增书签文件失败",!0)}catch(g){m("新增书签文件失败："+g.message,!0)}},document.getElementById("deleteBookmarkFile").onclick=async function(){const n=d.value;if(!n){m("请先选择要删除的书签文件",!0);return}if(!confirm(`确定要删除书签文件：${n.split("/").pop()} 吗？`))return;const t=o.value.trim(),s=a.value.trim(),l=e.value.trim(),u=i.value;if(!t||!s||!l||!u){m("请先填写完整的配置信息",!0);return}try{const f=`https://gitee.com/api/v5/repos/${s}/${l}/contents/${encodeURIComponent(n)}?ref=${u}&access_token=${t}`,h=await fetch(f);if(!h.ok){m("获取文件信息失败",!0);return}const g=await h.json(),y=`https://gitee.com/api/v5/repos/${s}/${l}/contents/${encodeURIComponent(n)}?ref=${u}&access_token=${t}`;(await fetch(y,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:t,message:`删除书签文件：${n.split("/").pop()}`,sha:g.sha,branch:u})})).ok?(m(`删除书签文件成功：${n.split("/").pop()}`),b()):m("删除书签文件失败",!0)}catch(f){m("删除书签文件失败："+f.message,!0)}},document.getElementById("openGiteeRepo").onclick=function(){const n=a.value.trim(),t=e.value.trim(),s=i.value,l=d.value;if(!n||!t){m("请先填写仓库所有者(owner)和仓库名(repo)",!0);return}if(!l){m("请先选择书签文件",!0);return}let u=`https://gitee.com/${n}/${t}/blob/${s}/${l}`;window.open(u,"_blank")};const N=document.getElementById("openSystemBookmarksBtn");N&&(N.onclick=function(){chrome&&chrome.tabs&&chrome.tabs.create?chrome.tabs.create({url:"chrome://bookmarks/"},function(){chrome.runtime.lastError&&alert("无法自动打开书签管理器，请手动访问 chrome://bookmarks/")}):alert("请手动打开 chrome://bookmarks/")});const j=document.getElementById("openMyBookmarksBtn");j&&(j.onclick=function(){chrome&&chrome.tabs&&chrome.tabs.create?chrome.tabs.create({url:chrome.runtime.getURL("bookmark-manager.html")},function(){chrome.runtime.lastError&&alert("无法打开我的书签管理器")}):window.open("bookmark-manager.html","_blank")});const U=document.getElementById("helpBtn"),w=document.getElementById("helpModal"),_=document.getElementById("helpClose");U&&w&&_&&(U.onclick=()=>{w.style.display="flex"},_.onclick=()=>{w.style.display="none"},w.onclick=n=>{n.target===w&&(w.style.display="none")})});
