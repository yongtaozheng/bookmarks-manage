function isChromeExtensionContext(){return typeof chrome<"u"&&chrome.runtime&&chrome.runtime.sendMessage}let cmdCount=0,lastCmdTime=0,searchBox=null,inputEl=null,resultList=null,results=[],selectedIdx=-1,allBookmarks=[],isComposing=!1;async function fetchAllBookmarks(){return isChromeExtensionContext()?new Promise(e=>{try{chrome.runtime.sendMessage({type:"getAllBookmarks"},s=>{if(chrome.runtime.lastError){console.warn("Chrome runtime error:",chrome.runtime.lastError),e([]);return}e((s==null?void 0:s.tree)||[])})}catch(s){console.warn("Error fetching bookmarks:",s),e([])}}):[]}window.addEventListener("keydown",e=>{try{if((e.key==="Meta"||e.key==="OS")&&!e.repeat){const s=Date.now();s-lastCmdTime<800?cmdCount++:cmdCount=1,lastCmdTime=s,cmdCount===3&&(e.preventDefault(),showSearchBox(),cmdCount=0)}else if(e.key==="Escape"&&searchBox)removeSearchBox();else if(e.altKey&&(e.key==="w"||e.key==="W")&&typeof chrome<"u"&&chrome.tabs&&chrome.tabs.remove){e.preventDefault();try{chrome.runtime.sendMessage({type:"closeCurrentTab"})}catch{}}}catch(s){console.warn("Error in keydown handler:",s)}},!0);function showSearchBox(){searchBox||(searchBox=document.createElement("div"),searchBox.style.position="fixed",searchBox.style.top="0",searchBox.style.left="50%",searchBox.style.transform="translateX(-50%)",searchBox.style.zIndex="999999",searchBox.style.background="transparent",searchBox.style.width="100vw",searchBox.style.display="flex",searchBox.style.flexDirection="column",searchBox.style.alignItems="center",searchBox.style.pointerEvents="none",inputEl=document.createElement("input"),inputEl.type="text",inputEl.placeholder="搜索书签...",inputEl.style.fontSize="1.2em",inputEl.style.padding="0.5em 1em",inputEl.style.border="1.5px solid #42b983",inputEl.style.borderRadius="6px",inputEl.style.outline="none",inputEl.style.marginTop="1.5em",inputEl.style.background="#fff",inputEl.style.width="50%",inputEl.style.maxWidth="90vw",inputEl.style.height="3em",inputEl.style.lineHeight="3em",inputEl.style.boxShadow="0 2px 16px 0 rgba(60,60,60,0.18)",inputEl.style.pointerEvents="auto",resultList=document.createElement("ul"),resultList.style.position="absolute",resultList.style.top="calc(1.5em + 3em)",resultList.style.left="50%",resultList.style.transform="translateX(-50%)",resultList.style.listStyle="none",resultList.style.margin="0",resultList.style.padding="0",resultList.style.width="50%",resultList.style.maxWidth="90vw",resultList.style.maxHeight="260px",resultList.style.overflowY="auto",resultList.style.overflowX="hidden",resultList.style.background="#fff",resultList.style.borderRadius="6px",resultList.style.boxShadow="0 1px 8px 0 rgba(60,60,60,0.08)",resultList.style.pointerEvents="auto",searchBox.appendChild(inputEl),searchBox.appendChild(resultList),document.body.appendChild(searchBox),inputEl.focus(),inputEl.addEventListener("compositionstart",()=>{isComposing=!0}),inputEl.addEventListener("compositionend",()=>{isComposing=!1}),inputEl.addEventListener("input",()=>{window.onInputAsync&&window.onInputAsync()}),inputEl.addEventListener("keydown",onInputKeydown),document.addEventListener("mousedown",onDocClick,!0),allBookmarks.length||fetchAllBookmarks().then(e=>{allBookmarks=[];function s(r,n){r.forEach(t=>{t.url?allBookmarks.push({...t,type:"bookmark",parent:n}):t.children&&(allBookmarks.push({...t,type:"folder",parent:n}),s(t.children,t))})}s(e)}))}function removeSearchBox(){searchBox&&(searchBox.remove(),searchBox=null,inputEl=null,resultList=null,results=[],selectedIdx=-1,document.removeEventListener("mousedown",onDocClick,!0))}function getBookmarkUsageKey(e){return e.url||e.id}async function getUsageData(){return new Promise(e=>{chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.get(["bookmark_usage"],s=>{try{e(s.bookmark_usage?JSON.parse(s.bookmark_usage):{})}catch{e({})}}):e({})})}async function setUsageData(e){return new Promise(s=>{chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.set({bookmark_usage:JSON.stringify(e)},()=>s()):s()})}async function recordBookmarkUsage(e){const s=getBookmarkUsageKey(e),r=await getUsageData();r[s]||(r[s]={count:0,last:0}),r[s].count+=1,r[s].last=Date.now(),await setUsageData(r)}async function onInput(){const e=inputEl.value.trim().toLowerCase();if(!e){renderResults([]);return}const s=allBookmarks.filter(t=>t.type==="folder"&&t.title&&t.title.toLowerCase().includes(e));if(s.length>0){let t=function(a){a.forEach(l=>{l.url&&o.push(l),l.children&&t(l.children)})};const o=[];s.forEach(a=>t(a.children||[])),results=o,selectedIdx=results.length?0:-1,renderResults(results);return}const r=await getUsageData();results=allBookmarks.filter(t=>t.type==="bookmark").map(t=>{const o=fuzzyScore(e,t.title||"",t.url||""),a=getBookmarkUsageKey(t),l=r[a]||{count:0,last:0};return{...t,score:o,usageCount:l.count,lastUsed:l.last}}).filter(t=>t.score>0).sort((t,o)=>o.lastUsed!==t.lastUsed?o.lastUsed-t.lastUsed:o.usageCount!==t.usageCount?o.usageCount-t.usageCount:o.score-t.score).slice(0,5),selectedIdx=results.length?0:-1,renderResults(results)}function fuzzyScore(e,s,r){if(s=s.toLowerCase(),r=r.toLowerCase(),s.includes(e))return 100+(100-s.indexOf(e));if(r.includes(e))return 80+(100-r.indexOf(e));if(s.replace(/\s/g,"").startsWith(e.replace(/\s/g,"")))return 60;let n=0,t=0;for(let o of e){if(t=s.indexOf(o,t),t===-1)return 0;n++,t++}return n>0?30+n:0}function renderResults(e,s){resultList&&(resultList.innerHTML="",e.forEach((r,n)=>{const t=document.createElement("li");t.textContent=r.title+(r.url?` (${r.url})`:""),t.style.padding="0.4em 0.8em",t.style.cursor="pointer",t.style.background=n===selectedIdx?"#e3eefa":"#fff",t.style.color=n===selectedIdx?"#1976d2":"#333",t.style.fontSize="0.98em",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.display="-webkit-box",t.style.webkitBoxOrient="vertical",t.style.webkitLineClamp="5",t.style.maxHeight="7em",t.style.wordBreak="break-all",t.onmouseenter=()=>{selectedIdx=n,renderResults(e)},t.onmousedown=o=>{o.preventDefault(),jumpTo(n)},resultList.appendChild(t)}),selectedIdx>=0&&resultList.children[selectedIdx+0]&&resultList.children[selectedIdx+0].scrollIntoView({block:"nearest",inline:"nearest"}))}function onInputKeydown(e){isComposing||results.length&&(e.key==="ArrowDown"?(e.preventDefault(),selectedIdx=(selectedIdx+1)%results.length,renderResults(results)):e.key==="ArrowUp"?(e.preventDefault(),selectedIdx=(selectedIdx-1+results.length)%results.length,renderResults(results)):e.key==="Enter"&&(e.preventDefault(),selectedIdx>=0&&selectedIdx<results.length&&(async()=>await jumpTo(selectedIdx))()))}async function jumpTo(idx){const bookmark=results[idx],url=bookmark==null?void 0:bookmark.url;if(url){if(await recordBookmarkUsage(bookmark),url.startsWith("javascript:"))try{const script=url.substring(11);eval(script)}catch(e){console.warn("Failed to execute bookmark script:",e)}else if(url.startsWith("data:"))try{window.open(url,"_blank")||alert("请手动打开书签："+url)}catch(e){console.warn("Failed to open data URL:",e),alert("无法打开此类型的书签，请手动访问："+url)}else window.open(url,"_blank");removeSearchBox()}}function onDocClick(e){searchBox&&!searchBox.contains(e.target)&&removeSearchBox()}typeof window<"u"&&(window.onInputAsync=onInput);
