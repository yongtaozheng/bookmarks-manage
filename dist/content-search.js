function isChromeExtensionContext(){return typeof chrome<"u"&&chrome.runtime&&chrome.runtime.sendMessage}let cmdCount=0,lastCmdTime=0,searchBox=null,inputEl=null,resultList=null,results=[],selectedIdx=-1,allBookmarks=[],isComposing=!1,keyboardPriority=!1;async function fetchAllBookmarks(){return isChromeExtensionContext()?new Promise(t=>{try{chrome.runtime.sendMessage({type:"getAllBookmarks"},s=>{if(chrome.runtime.lastError){console.warn("Chrome runtime error:",chrome.runtime.lastError),t([]);return}t((s==null?void 0:s.tree)||[])})}catch(s){console.warn("Error fetching bookmarks:",s),t([])}}):[]}window.addEventListener("keydown",t=>{try{if(t.key==="Meta"||t.key==="OS"||t.key==="Control"||t.key==="Alt"){const o=Date.now();o-lastCmdTime<800?cmdCount++:cmdCount=1,lastCmdTime=o,cmdCount===3&&(t.preventDefault(),showSearchBox(),cmdCount=0)}else if(t.key==="Escape"&&searchBox)removeSearchBox();else if(t.altKey&&(t.key==="w"||t.key==="W")&&typeof chrome<"u"&&chrome.tabs&&chrome.tabs.remove){t.preventDefault();try{chrome.runtime.sendMessage({type:"closeCurrentTab"})}catch{}}else cmdCount=0,lastCmdTime=0}catch(s){console.warn("Error in keydown handler:",s)}},!0);if(window.location.href.includes("gitee.com/api/v5/swagger")){let t=function(){const r=document.querySelector('input[name="access_token"].ivu-input');if(!r)return;const e=r.textContent||r.value;if(e&&e.length>20&&e!==s){s=e,console.log("检测到新token，发送更新消息");try{chrome&&chrome.runtime&&chrome.runtime.sendMessage?(console.log("发送消息到background:",{type:"updateToken",token:e}),chrome.runtime.sendMessage({type:"updateToken",token:e},n=>{chrome.runtime.lastError?console.log("发送消息失败:",chrome.runtime.lastError):console.log("消息发送成功，响应:",n)})):console.log("chrome.runtime.sendMessage不可用")}catch(n){console.log("发送消息时出错:",n)}}},s="";console.log("Gitee API页面，检测token生成"),t(),new MutationObserver(r=>{r.forEach(e=>{e.type==="childList"&&t()})}).observe(document.body,{childList:!0,subtree:!0}),setTimeout(t,1e3)}function showSearchBox(){searchBox||(searchBox=document.createElement("div"),searchBox.style.position="fixed",searchBox.style.top="0",searchBox.style.left="50%",searchBox.style.transform="translateX(-50%)",searchBox.style.zIndex="999999",searchBox.style.background="transparent",searchBox.style.width="100vw",searchBox.style.display="flex",searchBox.style.flexDirection="column",searchBox.style.alignItems="center",searchBox.style.pointerEvents="none",inputEl=document.createElement("input"),inputEl.type="text",inputEl.placeholder="搜索书签...",inputEl.style.fontSize="1.4em",inputEl.style.fontFamily="'YunFengJingLong', 'Microsoft YaHei', '微软雅黑', sans-serif",inputEl.style.padding="0.5em 1em",inputEl.style.border="1.5px solid #42b983",inputEl.style.borderRadius="6px",inputEl.style.outline="none",inputEl.style.marginTop="1.5em",inputEl.style.background="#fff",inputEl.style.width="50%",inputEl.style.maxWidth="90vw",inputEl.style.height="3em",inputEl.style.lineHeight="3em",inputEl.style.boxShadow="0 2px 16px 0 rgba(60,60,60,0.18)",inputEl.style.pointerEvents="auto",resultList=document.createElement("ul"),resultList.style.position="absolute",resultList.style.top="6em",resultList.style.left="50%",resultList.style.transform="translateX(-50%)",resultList.style.listStyle="none",resultList.style.margin="0",resultList.style.padding="0",resultList.style.width="50%",resultList.style.maxWidth="90vw",resultList.style.maxHeight="260px",resultList.style.overflowY="auto",resultList.style.overflowX="hidden",resultList.style.background="#fff",resultList.style.borderRadius="6px",resultList.style.boxShadow="0 1px 8px 0 rgba(60,60,60,0.08)",resultList.style.pointerEvents="auto",searchBox.appendChild(inputEl),searchBox.appendChild(resultList),document.body.appendChild(searchBox),searchBox.addEventListener("mousemove",()=>{keyboardPriority=!1}),inputEl.focus(),inputEl.addEventListener("compositionstart",()=>{isComposing=!0}),inputEl.addEventListener("compositionend",()=>{isComposing=!1}),inputEl.addEventListener("input",()=>{window.onInputAsync&&window.onInputAsync()}),inputEl.addEventListener("keydown",onInputKeydown),document.addEventListener("mousedown",onDocClick,!0),allBookmarks.length||fetchAllBookmarks().then(t=>{allBookmarks=[];function s(o,r){o.forEach(e=>{e.url?allBookmarks.push({...e,type:"bookmark",parent:r}):e.children&&(allBookmarks.push({...e,type:"folder",parent:r}),s(e.children,e))})}s(t)}))}function removeSearchBox(){searchBox&&(searchBox.remove(),searchBox=null,inputEl=null,resultList=null,results=[],selectedIdx=-1,keyboardPriority=!1,document.removeEventListener("mousedown",onDocClick,!0))}function getBookmarkUsageKey(t){return t.url||t.id}async function getUsageData(){return new Promise(t=>{chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.get(["bookmark_usage"],s=>{try{t(s.bookmark_usage?JSON.parse(s.bookmark_usage):{})}catch{t({})}}):t({})})}async function setUsageData(t){return new Promise(s=>{chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.set({bookmark_usage:JSON.stringify(t)},()=>s()):s()})}async function recordBookmarkUsage(t){const s=getBookmarkUsageKey(t),o=await getUsageData();o[s]||(o[s]={count:0,last:0}),o[s].count+=1,o[s].last=Date.now(),await setUsageData(o)}async function onInput(){const t=inputEl.value.trim().toLowerCase();if(!t){renderResults([]);return}const s=allBookmarks.filter(e=>e.type==="folder"&&e.title&&e.title.toLowerCase().includes(t));if(s.length>0){let e=function(i){i.forEach(l=>{l.url&&n.push(l),l.children&&e(l.children)})};const n=[];s.forEach(i=>e(i.children||[])),results=n,selectedIdx=results.length?0:-1,renderResults(results);return}const o=await getUsageData();results=allBookmarks.filter(e=>e.type==="bookmark").map(e=>{const n=fuzzyScore(t,e.title||"",e.url||""),i=getBookmarkUsageKey(e),l=o[i]||{count:0,last:0};return{...e,score:n,usageCount:l.count,lastUsed:l.last}}).filter(e=>e.score>0).sort((e,n)=>n.lastUsed!==e.lastUsed?n.lastUsed-e.lastUsed:n.usageCount!==e.usageCount?n.usageCount-e.usageCount:n.score-e.score).slice(0,5),selectedIdx=results.length?0:-1,renderResults(results)}function fuzzyScore(t,s,o){if(s=s.toLowerCase(),o=o.toLowerCase(),s.includes(t))return 100+(100-s.indexOf(t));if(o.includes(t))return 80+(100-o.indexOf(t));if(s.replace(/\s/g,"").startsWith(t.replace(/\s/g,"")))return 60;let r=0,e=0;for(let n of t){if(e=s.indexOf(n,e),e===-1)return 0;r++,e++}return r>0?30+r:0}function renderResults(t,s){resultList&&(resultList.innerHTML="",t.forEach((o,r)=>{const e=document.createElement("li");e.textContent=o.title+(o.url?` (${o.url})`:""),e.style.padding="0.4em 0.8em",e.style.cursor="pointer",e.style.background=r===selectedIdx?"#e3eefa":"#fff",e.style.color=r===selectedIdx?"#1976d2":"#333",e.style.fontSize="1.1em",e.style.fontFamily="'YunFengJingLong', 'Microsoft YaHei', '微软雅黑', sans-serif",e.style.overflow="hidden",e.style.textOverflow="ellipsis",e.style.display="-webkit-box",e.style.webkitBoxOrient="vertical",e.style.webkitLineClamp="5",e.style.maxHeight="7em",e.style.wordBreak="break-all",e.onmouseenter=()=>{keyboardPriority||(selectedIdx=r,renderResults(t))},e.onmousedown=n=>{n.preventDefault(),jumpTo(r)},resultList.appendChild(e)}),selectedIdx>=0&&resultList.children[selectedIdx+0]&&resultList.children[selectedIdx+0].scrollIntoView({block:"nearest",inline:"nearest"}))}function onInputKeydown(t){isComposing||results.length&&(t.key==="ArrowDown"?(t.preventDefault(),keyboardPriority=!0,selectedIdx=(selectedIdx+1)%results.length,renderResults(results)):t.key==="ArrowUp"?(t.preventDefault(),keyboardPriority=!0,selectedIdx=(selectedIdx-1+results.length)%results.length,renderResults(results)):t.key==="Enter"&&(t.preventDefault(),selectedIdx>=0&&selectedIdx<results.length&&(async()=>await jumpTo(selectedIdx))()))}async function jumpTo(idx){const bookmark=results[idx],url=bookmark==null?void 0:bookmark.url;if(url){if(await recordBookmarkUsage(bookmark),url.startsWith("javascript:"))try{const script=url.substring(11);eval(script)}catch(t){console.warn("Failed to execute bookmark script:",t)}else if(url.startsWith("data:"))try{window.open(url,"_blank")||alert("请手动打开书签："+url)}catch(t){console.warn("Failed to open data URL:",t),alert("无法打开此类型的书签，请手动访问："+url)}else window.open(url,"_blank");removeSearchBox()}}function onDocClick(t){searchBox&&!searchBox.contains(t.target)&&removeSearchBox()}typeof window<"u"&&(window.onInputAsync=onInput);
