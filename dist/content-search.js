let p=0,w=0,r=null,o=null,n=null,a=[],i=-1,c=[],m=!1;async function v(){return new Promise(e=>{chrome.runtime.sendMessage({type:"getAllBookmarks"},s=>{e(s?.tree||[])})})}window.addEventListener("keydown",e=>{if((e.key==="Meta"||e.key==="OS")&&!e.repeat){const s=Date.now();s-w<800?p++:p=1,w=s,p===3&&(e.preventDefault(),x(),p=0)}else e.key==="Escape"&&r&&h()},!0);function x(){r||(r=document.createElement("div"),r.style.position="fixed",r.style.top="0",r.style.left="50%",r.style.transform="translateX(-50%)",r.style.zIndex="999999",r.style.background="transparent",r.style.width="100vw",r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.pointerEvents="none",o=document.createElement("input"),o.type="text",o.placeholder="搜索书签...",o.style.fontSize="1.2em",o.style.padding="0.5em 1em",o.style.border="1.5px solid #42b983",o.style.borderRadius="6px",o.style.outline="none",o.style.marginTop="1.5em",o.style.background="#fff",o.style.width="420px",o.style.maxWidth="90vw",o.style.boxShadow="0 2px 16px 0 rgba(60,60,60,0.18)",o.style.pointerEvents="auto",n=document.createElement("ul"),n.style.position="absolute",n.style.top="calc(1.5em + 2.6em)",n.style.left="50%",n.style.transform="translateX(-50%)",n.style.listStyle="none",n.style.margin="0",n.style.padding="0",n.style.width="420px",n.style.maxWidth="90vw",n.style.maxHeight="260px",n.style.overflowY="auto",n.style.overflowX="hidden",n.style.background="#fff",n.style.borderRadius="6px",n.style.boxShadow="0 1px 8px 0 rgba(60,60,60,0.08)",n.style.pointerEvents="auto",r.appendChild(o),r.appendChild(n),document.body.appendChild(r),o.focus(),o.addEventListener("compositionstart",()=>{m=!0}),o.addEventListener("compositionend",()=>{m=!1}),o.addEventListener("input",E),o.addEventListener("keydown",C),document.addEventListener("mousedown",g,!0),c.length||v().then(e=>{c=[];function s(d,l){d.forEach(t=>{t.url?c.push({...t,type:"bookmark",parent:l}):t.children&&(c.push({...t,type:"folder",parent:l}),s(t.children,t))})}s(e)}))}function h(){r&&(r.remove(),r=null,o=null,n=null,a=[],i=-1,document.removeEventListener("mousedown",g,!0))}function E(){const e=o.value.trim().toLowerCase();if(!e){u([]);return}const s=c.filter(l=>l.type==="folder"&&l.title&&l.title.toLowerCase().includes(e));if(s.length>0){let l=function(f){f.forEach(y=>{y.url&&t.push(y),y.children&&l(y.children)})};const t=[];s.forEach(f=>l(f.children||[])),a=t,i=a.length?0:-1,u(a);return}a=c.filter(l=>l.type==="bookmark").map(l=>({...l,score:b(e,l.title||"",l.url||"")})).filter(l=>l.score>0).sort((l,t)=>t.score-l.score).slice(0,5),i=a.length?0:-1,u(a)}function b(e,s,d){if(s=s.toLowerCase(),d=d.toLowerCase(),s.includes(e))return 100+(100-s.indexOf(e));if(d.includes(e))return 80+(100-d.indexOf(e));if(s.replace(/\s/g,"").startsWith(e.replace(/\s/g,"")))return 60;let l=0,t=0;for(let f of e){if(t=s.indexOf(f,t),t===-1)return 0;l++,t++}return l>0?30+l:0}function u(e,s){n&&(n.innerHTML="",e.forEach((d,l)=>{const t=document.createElement("li");t.textContent=d.title+(d.url?` (${d.url})`:""),t.style.padding="0.4em 0.8em",t.style.cursor="pointer",t.style.background=l===i?"#e3eefa":"#fff",t.style.color=l===i?"#1976d2":"#333",t.style.fontSize="0.98em",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.display="-webkit-box",t.style.webkitBoxOrient="vertical",t.style.webkitLineClamp="5",t.style.maxHeight="7em",t.style.wordBreak="break-all",t.onmouseenter=()=>{i=l,u(e)},t.onmousedown=f=>{f.preventDefault(),k(l)},n.appendChild(t)}),i>=0&&n.children[i+0]&&n.children[i+0].scrollIntoView({block:"nearest",inline:"nearest"}))}function C(e){m||a.length&&(e.key==="ArrowDown"?(e.preventDefault(),i=(i+1)%a.length,u(a)):e.key==="ArrowUp"?(e.preventDefault(),i=(i-1+a.length)%a.length,u(a)):e.key==="Enter"&&(e.preventDefault(),i>=0&&i<a.length&&k(i)))}function k(e){const s=a[e]?.url;s&&(window.open(s,"_blank"),h())}function g(e){r&&!r.contains(e.target)&&h()}
