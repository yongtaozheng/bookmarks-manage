function C(){return typeof chrome<"u"&&chrome.runtime&&chrome.runtime.sendMessage}let h=0,w=0,l=null,o=null,r=null,i=[],a=-1,f=[],p=!1;async function b(){return C()?new Promise(e=>{try{chrome.runtime.sendMessage({type:"getAllBookmarks"},n=>{if(chrome.runtime.lastError){console.warn("Chrome runtime error:",chrome.runtime.lastError),e([]);return}e((n==null?void 0:n.tree)||[])})}catch(n){console.warn("Error fetching bookmarks:",n),e([])}}):[]}window.addEventListener("keydown",e=>{try{if((e.key==="Meta"||e.key==="OS")&&!e.repeat){const n=Date.now();n-w<800?h++:h=1,w=n,h===3&&(e.preventDefault(),L(),h=0)}else if(e.key==="Escape"&&l)g();else if(e.altKey&&(e.key==="w"||e.key==="W")&&typeof chrome<"u"&&chrome.tabs&&chrome.tabs.remove){e.preventDefault();try{chrome.runtime.sendMessage({type:"closeCurrentTab"})}catch{}}}catch(n){console.warn("Error in keydown handler:",n)}},!0);function L(){l||(l=document.createElement("div"),l.style.position="fixed",l.style.top="0",l.style.left="50%",l.style.transform="translateX(-50%)",l.style.zIndex="999999",l.style.background="transparent",l.style.width="100vw",l.style.display="flex",l.style.flexDirection="column",l.style.alignItems="center",l.style.pointerEvents="none",o=document.createElement("input"),o.type="text",o.placeholder="搜索书签...",o.style.fontSize="1.2em",o.style.padding="0.5em 1em",o.style.border="1.5px solid #42b983",o.style.borderRadius="6px",o.style.outline="none",o.style.marginTop="1.5em",o.style.background="#fff",o.style.width="50%",o.style.maxWidth="90vw",o.style.height="3em",o.style.lineHeight="3em",o.style.boxShadow="0 2px 16px 0 rgba(60,60,60,0.18)",o.style.pointerEvents="auto",r=document.createElement("ul"),r.style.position="absolute",r.style.top="calc(1.5em + 3em)",r.style.left="50%",r.style.transform="translateX(-50%)",r.style.listStyle="none",r.style.margin="0",r.style.padding="0",r.style.width="50%",r.style.maxWidth="90vw",r.style.maxHeight="260px",r.style.overflowY="auto",r.style.overflowX="hidden",r.style.background="#fff",r.style.borderRadius="6px",r.style.boxShadow="0 1px 8px 0 rgba(60,60,60,0.08)",r.style.pointerEvents="auto",l.appendChild(o),l.appendChild(r),document.body.appendChild(l),o.focus(),o.addEventListener("compositionstart",()=>{p=!0}),o.addEventListener("compositionend",()=>{p=!1}),o.addEventListener("input",()=>{window.onInputAsync&&window.onInputAsync()}),o.addEventListener("keydown",I),document.addEventListener("mousedown",E,!0),f.length||b().then(e=>{f=[];function n(s,u){s.forEach(t=>{t.url?f.push({...t,type:"bookmark",parent:u}):t.children&&(f.push({...t,type:"folder",parent:u}),n(t.children,t))})}n(e)}))}function g(){l&&(l.remove(),l=null,o=null,r=null,i=[],a=-1,document.removeEventListener("mousedown",E,!0))}function k(e){return e.url||e.id}async function x(){return new Promise(e=>{chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.get(["bookmark_usage"],n=>{try{e(n.bookmark_usage?JSON.parse(n.bookmark_usage):{})}catch{e({})}}):e({})})}async function D(e){return new Promise(n=>{chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.set({bookmark_usage:JSON.stringify(e)},()=>n()):n()})}async function B(e){const n=k(e),s=await x();s[n]||(s[n]={count:0,last:0}),s[n].count+=1,s[n].last=Date.now(),await D(s)}async function S(){const e=o.value.trim().toLowerCase();if(!e){y([]);return}const n=f.filter(t=>t.type==="folder"&&t.title&&t.title.toLowerCase().includes(e));if(n.length>0){let t=function(m){m.forEach(d=>{d.url&&c.push(d),d.children&&t(d.children)})};const c=[];n.forEach(m=>t(m.children||[])),i=c,a=i.length?0:-1,y(i);return}const s=await x();i=f.filter(t=>t.type==="bookmark").map(t=>{const c=U(e,t.title||"",t.url||""),m=k(t),d=s[m]||{count:0,last:0};return{...t,score:c,usageCount:d.count,lastUsed:d.last}}).filter(t=>t.score>0).sort((t,c)=>c.lastUsed!==t.lastUsed?c.lastUsed-t.lastUsed:c.usageCount!==t.usageCount?c.usageCount-t.usageCount:c.score-t.score).slice(0,5),a=i.length?0:-1,y(i)}function U(e,n,s){if(n=n.toLowerCase(),s=s.toLowerCase(),n.includes(e))return 100+(100-n.indexOf(e));if(s.includes(e))return 80+(100-s.indexOf(e));if(n.replace(/\s/g,"").startsWith(e.replace(/\s/g,"")))return 60;let u=0,t=0;for(let c of e){if(t=n.indexOf(c,t),t===-1)return 0;u++,t++}return u>0?30+u:0}function y(e,n){r&&(r.innerHTML="",e.forEach((s,u)=>{const t=document.createElement("li");t.textContent=s.title+(s.url?` (${s.url})`:""),t.style.padding="0.4em 0.8em",t.style.cursor="pointer",t.style.background=u===a?"#e3eefa":"#fff",t.style.color=u===a?"#1976d2":"#333",t.style.fontSize="0.98em",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.display="-webkit-box",t.style.webkitBoxOrient="vertical",t.style.webkitLineClamp="5",t.style.maxHeight="7em",t.style.wordBreak="break-all",t.onmouseenter=()=>{a=u,y(e)},t.onmousedown=c=>{c.preventDefault(),v(u)},r.appendChild(t)}),a>=0&&r.children[a+0]&&r.children[a+0].scrollIntoView({block:"nearest",inline:"nearest"}))}function I(e){p||i.length&&(e.key==="ArrowDown"?(e.preventDefault(),a=(a+1)%i.length,y(i)):e.key==="ArrowUp"?(e.preventDefault(),a=(a-1+i.length)%i.length,y(i)):e.key==="Enter"&&(e.preventDefault(),a>=0&&a<i.length&&(async()=>await v(a))()))}async function v(e){const n=i[e],s=n==null?void 0:n.url;s&&(await B(n),window.open(s,"_blank"),g())}function E(e){l&&!l.contains(e.target)&&g()}typeof window<"u"&&(window.onInputAsync=S);
