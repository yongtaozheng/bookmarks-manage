function isChromeExtensionContext(){return typeof chrome<"u"&&chrome.runtime&&chrome.runtime.sendMessage}let cmdCount=0,lastCmdTime=0,searchBox=null,inputEl=null,resultList=null,results=[],selectedIdx=-1,allBookmarks=[],isComposing=!1,keyboardPriority=!1;async function fetchAllBookmarks(){return isChromeExtensionContext()?new Promise(e=>{try{chrome.runtime.sendMessage({type:"getAllBookmarks"},s=>{if(chrome.runtime.lastError){console.warn("Chrome runtime error:",chrome.runtime.lastError),e([]);return}e((s==null?void 0:s.tree)||[])})}catch(s){console.warn("Error fetching bookmarks:",s),e([])}}):[]}window.addEventListener("keydown",e=>{try{if(e.key==="Meta"||e.key==="OS"||e.key==="Control"||e.key==="Alt"){const o=Date.now();o-lastCmdTime<800?cmdCount++:cmdCount=1,lastCmdTime=o,cmdCount===3&&(e.preventDefault(),showSearchBox(),cmdCount=0)}else if(e.key==="Escape"&&searchBox)removeSearchBox();else if(e.altKey&&(e.key==="w"||e.key==="W")&&typeof chrome<"u"&&chrome.tabs&&chrome.tabs.remove){e.preventDefault();try{chrome.runtime.sendMessage({type:"closeCurrentTab"})}catch{}}else cmdCount=0,lastCmdTime=0}catch(s){console.warn("Error in keydown handler:",s)}},!0);if(window.location.href.includes("gitee.com/api/v5/swagger")){let e=function(){const r=document.querySelector('input[name="access_token"].ivu-input');if(!r)return;const t=r.textContent||r.value;if(t&&t.length>20&&t!==s){s=t,console.log("检测到新token，发送更新消息");try{chrome&&chrome.runtime&&chrome.runtime.sendMessage?(console.log("发送消息到background:",{type:"updateToken",token:t}),chrome.runtime.sendMessage({type:"updateToken",token:t},n=>{chrome.runtime.lastError?console.log("发送消息失败:",chrome.runtime.lastError):console.log("消息发送成功，响应:",n)})):console.log("chrome.runtime.sendMessage不可用")}catch(n){console.log("发送消息时出错:",n)}}},s="";console.log("Gitee API页面，检测token生成"),e(),new MutationObserver(r=>{r.forEach(t=>{t.type==="childList"&&e()})}).observe(document.body,{childList:!0,subtree:!0}),setTimeout(e,1e3)}function showSearchBox(){searchBox||(searchBox=document.createElement("div"),searchBox.style.position="fixed",searchBox.style.top="0",searchBox.style.left="50%",searchBox.style.transform="translateX(-50%)",searchBox.style.zIndex="999999",searchBox.style.background="transparent",searchBox.style.width="100vw",searchBox.style.display="flex",searchBox.style.flexDirection="column",searchBox.style.alignItems="center",searchBox.style.pointerEvents="none",inputEl=document.createElement("input"),inputEl.type="text",inputEl.placeholder="搜索书签...",inputEl.style.fontSize="1.2em",inputEl.style.padding="0.5em 1em",inputEl.style.border="1.5px solid #42b983",inputEl.style.borderRadius="6px",inputEl.style.outline="none",inputEl.style.marginTop="1.5em",inputEl.style.background="#fff",inputEl.style.width="50%",inputEl.style.maxWidth="90vw",inputEl.style.height="3em",inputEl.style.lineHeight="3em",inputEl.style.boxShadow="0 2px 16px 0 rgba(60,60,60,0.18)",inputEl.style.pointerEvents="auto",resultList=document.createElement("ul"),resultList.style.position="absolute",resultList.style.top="calc(1.5em + 3em)",resultList.style.left="50%",resultList.style.transform="translateX(-50%)",resultList.style.listStyle="none",resultList.style.margin="0",resultList.style.padding="0",resultList.style.width="50%",resultList.style.maxWidth="90vw",resultList.style.maxHeight="260px",resultList.style.overflowY="auto",resultList.style.overflowX="hidden",resultList.style.background="#fff",resultList.style.borderRadius="6px",resultList.style.boxShadow="0 1px 8px 0 rgba(60,60,60,0.08)",resultList.style.pointerEvents="auto",searchBox.appendChild(inputEl),searchBox.appendChild(resultList),document.body.appendChild(searchBox),searchBox.addEventListener("mousemove",()=>{keyboardPriority=!1}),inputEl.focus(),inputEl.addEventListener("compositionstart",()=>{isComposing=!0}),inputEl.addEventListener("compositionend",()=>{isComposing=!1}),inputEl.addEventListener("input",()=>{window.onInputAsync&&window.onInputAsync()}),inputEl.addEventListener("keydown",onInputKeydown),document.addEventListener("mousedown",onDocClick,!0),allBookmarks.length||fetchAllBookmarks().then(e=>{allBookmarks=[];function s(o,r){o.forEach(t=>{t.url?allBookmarks.push({...t,type:"bookmark",parent:r}):t.children&&(allBookmarks.push({...t,type:"folder",parent:r}),s(t.children,t))})}s(e)}))}function removeSearchBox(){searchBox&&(searchBox.remove(),searchBox=null,inputEl=null,resultList=null,results=[],selectedIdx=-1,keyboardPriority=!1,document.removeEventListener("mousedown",onDocClick,!0))}function getBookmarkUsageKey(e){return e.url||e.id}async function getUsageData(){return new Promise(e=>{chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.get(["bookmark_usage"],s=>{try{e(s.bookmark_usage?JSON.parse(s.bookmark_usage):{})}catch{e({})}}):e({})})}async function setUsageData(e){return new Promise(s=>{chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.set({bookmark_usage:JSON.stringify(e)},()=>s()):s()})}async function recordBookmarkUsage(e){const s=getBookmarkUsageKey(e),o=await getUsageData();o[s]||(o[s]={count:0,last:0}),o[s].count+=1,o[s].last=Date.now(),await setUsageData(o)}async function onInput(){const e=inputEl.value.trim().toLowerCase();if(!e){renderResults([]);return}const s=allBookmarks.filter(t=>t.type==="folder"&&t.title&&t.title.toLowerCase().includes(e));if(s.length>0){let t=function(i){i.forEach(l=>{l.url&&n.push(l),l.children&&t(l.children)})};const n=[];s.forEach(i=>t(i.children||[])),results=n,selectedIdx=results.length?0:-1,renderResults(results);return}const o=await getUsageData();results=allBookmarks.filter(t=>t.type==="bookmark").map(t=>{const n=fuzzyScore(e,t.title||"",t.url||""),i=getBookmarkUsageKey(t),l=o[i]||{count:0,last:0};return{...t,score:n,usageCount:l.count,lastUsed:l.last}}).filter(t=>t.score>0).sort((t,n)=>n.lastUsed!==t.lastUsed?n.lastUsed-t.lastUsed:n.usageCount!==t.usageCount?n.usageCount-t.usageCount:n.score-t.score).slice(0,5),selectedIdx=results.length?0:-1,renderResults(results)}function fuzzyScore(e,s,o){if(s=s.toLowerCase(),o=o.toLowerCase(),s.includes(e))return 100+(100-s.indexOf(e));if(o.includes(e))return 80+(100-o.indexOf(e));if(s.replace(/\s/g,"").startsWith(e.replace(/\s/g,"")))return 60;let r=0,t=0;for(let n of e){if(t=s.indexOf(n,t),t===-1)return 0;r++,t++}return r>0?30+r:0}function renderResults(e,s){resultList&&(resultList.innerHTML="",e.forEach((o,r)=>{const t=document.createElement("li");t.textContent=o.title+(o.url?` (${o.url})`:""),t.style.padding="0.4em 0.8em",t.style.cursor="pointer",t.style.background=r===selectedIdx?"#e3eefa":"#fff",t.style.color=r===selectedIdx?"#1976d2":"#333",t.style.fontSize="0.98em",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.display="-webkit-box",t.style.webkitBoxOrient="vertical",t.style.webkitLineClamp="5",t.style.maxHeight="7em",t.style.wordBreak="break-all",t.onmouseenter=()=>{keyboardPriority||(selectedIdx=r,renderResults(e))},t.onmousedown=n=>{n.preventDefault(),jumpTo(r)},resultList.appendChild(t)}),selectedIdx>=0&&resultList.children[selectedIdx+0]&&resultList.children[selectedIdx+0].scrollIntoView({block:"nearest",inline:"nearest"}))}function onInputKeydown(e){isComposing||results.length&&(e.key==="ArrowDown"?(e.preventDefault(),keyboardPriority=!0,selectedIdx=(selectedIdx+1)%results.length,renderResults(results)):e.key==="ArrowUp"?(e.preventDefault(),keyboardPriority=!0,selectedIdx=(selectedIdx-1+results.length)%results.length,renderResults(results)):e.key==="Enter"&&(e.preventDefault(),selectedIdx>=0&&selectedIdx<results.length&&(async()=>await jumpTo(selectedIdx))()))}async function jumpTo(idx){const bookmark=results[idx],url=bookmark==null?void 0:bookmark.url;if(url){if(await recordBookmarkUsage(bookmark),url.startsWith("javascript:"))try{const script=url.substring(11);eval(script)}catch(e){console.warn("Failed to execute bookmark script:",e)}else if(url.startsWith("data:"))try{window.open(url,"_blank")||alert("请手动打开书签："+url)}catch(e){console.warn("Failed to open data URL:",e),alert("无法打开此类型的书签，请手动访问："+url)}else window.open(url,"_blank");removeSearchBox()}}function onDocClick(e){searchBox&&!searchBox.contains(e.target)&&removeSearchBox()}typeof window<"u"&&(window.onInputAsync=onInput);
