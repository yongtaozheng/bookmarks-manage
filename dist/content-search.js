function E(){return typeof chrome<"u"&&chrome.runtime&&chrome.runtime.sendMessage}let p=0,w=0,r=null,o=null,s=null,a=[],i=-1,f=[],h=!1;async function b(){return E()?new Promise(t=>{chrome.runtime.sendMessage({type:"getAllBookmarks"},n=>{t((n==null?void 0:n.tree)||[])})}):[]}window.addEventListener("keydown",t=>{if((t.key==="Meta"||t.key==="OS"||t.key==="Control")&&!t.repeat){const n=Date.now();n-w<800?p++:p=1,w=n,p===3&&(t.preventDefault(),L(),p=0)}else t.key==="Escape"&&r&&g()},!0);function L(){r||(r=document.createElement("div"),r.style.position="fixed",r.style.top="0",r.style.left="50%",r.style.transform="translateX(-50%)",r.style.zIndex="999999",r.style.background="transparent",r.style.width="100vw",r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.pointerEvents="none",o=document.createElement("input"),o.type="text",o.placeholder="搜索书签...",o.style.fontSize="1.2em",o.style.padding="0.5em 1em",o.style.border="1.5px solid #42b983",o.style.borderRadius="6px",o.style.outline="none",o.style.marginTop="1.5em",o.style.background="#fff",o.style.width="50%",o.style.maxWidth="90vw",o.style.height="3em",o.style.lineHeight="3em",o.style.boxShadow="0 2px 16px 0 rgba(60,60,60,0.18)",o.style.pointerEvents="auto",s=document.createElement("ul"),s.style.position="absolute",s.style.top="calc(1.5em + 3em)",s.style.left="50%",s.style.transform="translateX(-50%)",s.style.listStyle="none",s.style.margin="0",s.style.padding="0",s.style.width="50%",s.style.maxWidth="90vw",s.style.maxHeight="260px",s.style.overflowY="auto",s.style.overflowX="hidden",s.style.background="#fff",s.style.borderRadius="6px",s.style.boxShadow="0 1px 8px 0 rgba(60,60,60,0.08)",s.style.pointerEvents="auto",r.appendChild(o),r.appendChild(s),document.body.appendChild(r),o.focus(),o.addEventListener("compositionstart",()=>{h=!0}),o.addEventListener("compositionend",()=>{h=!1}),o.addEventListener("input",()=>{window.onInputAsync&&window.onInputAsync()}),o.addEventListener("keydown",I),document.addEventListener("mousedown",C,!0),f.length||b().then(t=>{f=[];function n(l,u){l.forEach(e=>{e.url?f.push({...e,type:"bookmark",parent:u}):e.children&&(f.push({...e,type:"folder",parent:u}),n(e.children,e))})}n(t)}))}function g(){r&&(r.remove(),r=null,o=null,s=null,a=[],i=-1,document.removeEventListener("mousedown",C,!0))}function k(t){return t.url||t.id}async function x(){return new Promise(t=>{chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.get(["bookmark_usage"],n=>{try{t(n.bookmark_usage?JSON.parse(n.bookmark_usage):{})}catch{t({})}}):t({})})}async function B(t){return new Promise(n=>{chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.set({bookmark_usage:JSON.stringify(t)},()=>n()):n()})}async function D(t){const n=k(t),l=await x();l[n]||(l[n]={count:0,last:0}),l[n].count+=1,l[n].last=Date.now(),await B(l)}async function S(){const t=o.value.trim().toLowerCase();if(!t){y([]);return}const n=f.filter(e=>e.type==="folder"&&e.title&&e.title.toLowerCase().includes(t));if(n.length>0){let e=function(m){m.forEach(d=>{d.url&&c.push(d),d.children&&e(d.children)})};const c=[];n.forEach(m=>e(m.children||[])),a=c,i=a.length?0:-1,y(a);return}const l=await x();a=f.filter(e=>e.type==="bookmark").map(e=>{const c=U(t,e.title||"",e.url||""),m=k(e),d=l[m]||{count:0,last:0};return{...e,score:c,usageCount:d.count,lastUsed:d.last}}).filter(e=>e.score>0).sort((e,c)=>c.lastUsed!==e.lastUsed?c.lastUsed-e.lastUsed:c.usageCount!==e.usageCount?c.usageCount-e.usageCount:c.score-e.score).slice(0,5),i=a.length?0:-1,y(a)}function U(t,n,l){if(n=n.toLowerCase(),l=l.toLowerCase(),n.includes(t))return 100+(100-n.indexOf(t));if(l.includes(t))return 80+(100-l.indexOf(t));if(n.replace(/\s/g,"").startsWith(t.replace(/\s/g,"")))return 60;let u=0,e=0;for(let c of t){if(e=n.indexOf(c,e),e===-1)return 0;u++,e++}return u>0?30+u:0}function y(t,n){s&&(s.innerHTML="",t.forEach((l,u)=>{const e=document.createElement("li");e.textContent=l.title+(l.url?` (${l.url})`:""),e.style.padding="0.4em 0.8em",e.style.cursor="pointer",e.style.background=u===i?"#e3eefa":"#fff",e.style.color=u===i?"#1976d2":"#333",e.style.fontSize="0.98em",e.style.overflow="hidden",e.style.textOverflow="ellipsis",e.style.display="-webkit-box",e.style.webkitBoxOrient="vertical",e.style.webkitLineClamp="5",e.style.maxHeight="7em",e.style.wordBreak="break-all",e.onmouseenter=()=>{i=u,y(t)},e.onmousedown=c=>{c.preventDefault(),v(u)},s.appendChild(e)}),i>=0&&s.children[i+0]&&s.children[i+0].scrollIntoView({block:"nearest",inline:"nearest"}))}function I(t){h||a.length&&(t.key==="ArrowDown"?(t.preventDefault(),i=(i+1)%a.length,y(a)):t.key==="ArrowUp"?(t.preventDefault(),i=(i-1+a.length)%a.length,y(a)):t.key==="Enter"&&(t.preventDefault(),i>=0&&i<a.length&&(async()=>await v(i))()))}async function v(t){const n=a[t],l=n==null?void 0:n.url;l&&(await D(n),window.open(l,"_blank"),g())}function C(t){r&&!r.contains(t.target)&&g()}typeof window<"u"&&(window.onInputAsync=S);
