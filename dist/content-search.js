let p=0,w=0,r=null,l=null,o=null,i=[],a=-1,f=[],h=!1;async function C(){return new Promise(t=>{chrome.runtime.sendMessage({type:"getAllBookmarks"},n=>{t((n==null?void 0:n.tree)||[])})})}window.addEventListener("keydown",t=>{if((t.key==="Meta"||t.key==="OS")&&!t.repeat){const n=Date.now();n-w<800?p++:p=1,w=n,p===3&&(t.preventDefault(),b(),p=0)}else t.key==="Escape"&&r&&g()},!0);function b(){r||(r=document.createElement("div"),r.style.position="fixed",r.style.top="0",r.style.left="50%",r.style.transform="translateX(-50%)",r.style.zIndex="999999",r.style.background="transparent",r.style.width="100vw",r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.pointerEvents="none",l=document.createElement("input"),l.type="text",l.placeholder="搜索书签...",l.style.fontSize="1.2em",l.style.padding="0.5em 1em",l.style.border="1.5px solid #42b983",l.style.borderRadius="6px",l.style.outline="none",l.style.marginTop="1.5em",l.style.background="#fff",l.style.width="420px",l.style.maxWidth="90vw",l.style.boxShadow="0 2px 16px 0 rgba(60,60,60,0.18)",l.style.pointerEvents="auto",o=document.createElement("ul"),o.style.position="absolute",o.style.top="calc(1.5em + 2.6em)",o.style.left="50%",o.style.transform="translateX(-50%)",o.style.listStyle="none",o.style.margin="0",o.style.padding="0",o.style.width="420px",o.style.maxWidth="90vw",o.style.maxHeight="260px",o.style.overflowY="auto",o.style.overflowX="hidden",o.style.background="#fff",o.style.borderRadius="6px",o.style.boxShadow="0 1px 8px 0 rgba(60,60,60,0.08)",o.style.pointerEvents="auto",r.appendChild(l),r.appendChild(o),document.body.appendChild(r),l.focus(),l.addEventListener("compositionstart",()=>{h=!0}),l.addEventListener("compositionend",()=>{h=!1}),l.addEventListener("input",()=>{window.onInputAsync&&window.onInputAsync()}),l.addEventListener("keydown",U),document.addEventListener("mousedown",E,!0),f.length||C().then(t=>{f=[];function n(s,u){s.forEach(e=>{e.url?f.push({...e,type:"bookmark",parent:u}):e.children&&(f.push({...e,type:"folder",parent:u}),n(e.children,e))})}n(t)}))}function g(){r&&(r.remove(),r=null,l=null,o=null,i=[],a=-1,document.removeEventListener("mousedown",E,!0))}function k(t){return t.url||t.id}async function x(){return new Promise(t=>{chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.get(["bookmark_usage"],n=>{try{t(n.bookmark_usage?JSON.parse(n.bookmark_usage):{})}catch{t({})}}):t({})})}async function L(t){return new Promise(n=>{chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.set({bookmark_usage:JSON.stringify(t)},()=>n()):n()})}async function B(t){const n=k(t),s=await x();s[n]||(s[n]={count:0,last:0}),s[n].count+=1,s[n].last=Date.now(),await L(s)}async function D(){const t=l.value.trim().toLowerCase();if(!t){y([]);return}const n=f.filter(e=>e.type==="folder"&&e.title&&e.title.toLowerCase().includes(t));if(n.length>0){let e=function(m){m.forEach(d=>{d.url&&c.push(d),d.children&&e(d.children)})};const c=[];n.forEach(m=>e(m.children||[])),i=c,a=i.length?0:-1,y(i);return}const s=await x();i=f.filter(e=>e.type==="bookmark").map(e=>{const c=S(t,e.title||"",e.url||""),m=k(e),d=s[m]||{count:0,last:0};return{...e,score:c,usageCount:d.count,lastUsed:d.last}}).filter(e=>e.score>0).sort((e,c)=>c.lastUsed!==e.lastUsed?c.lastUsed-e.lastUsed:c.usageCount!==e.usageCount?c.usageCount-e.usageCount:c.score-e.score).slice(0,5),a=i.length?0:-1,y(i)}function S(t,n,s){if(n=n.toLowerCase(),s=s.toLowerCase(),n.includes(t))return 100+(100-n.indexOf(t));if(s.includes(t))return 80+(100-s.indexOf(t));if(n.replace(/\s/g,"").startsWith(t.replace(/\s/g,"")))return 60;let u=0,e=0;for(let c of t){if(e=n.indexOf(c,e),e===-1)return 0;u++,e++}return u>0?30+u:0}function y(t,n){o&&(o.innerHTML="",t.forEach((s,u)=>{const e=document.createElement("li");e.textContent=s.title+(s.url?` (${s.url})`:""),e.style.padding="0.4em 0.8em",e.style.cursor="pointer",e.style.background=u===a?"#e3eefa":"#fff",e.style.color=u===a?"#1976d2":"#333",e.style.fontSize="0.98em",e.style.overflow="hidden",e.style.textOverflow="ellipsis",e.style.display="-webkit-box",e.style.webkitBoxOrient="vertical",e.style.webkitLineClamp="5",e.style.maxHeight="7em",e.style.wordBreak="break-all",e.onmouseenter=()=>{a=u,y(t)},e.onmousedown=c=>{c.preventDefault(),v(u)},o.appendChild(e)}),a>=0&&o.children[a+0]&&o.children[a+0].scrollIntoView({block:"nearest",inline:"nearest"}))}function U(t){h||i.length&&(t.key==="ArrowDown"?(t.preventDefault(),a=(a+1)%i.length,y(i)):t.key==="ArrowUp"?(t.preventDefault(),a=(a-1+i.length)%i.length,y(i)):t.key==="Enter"&&(t.preventDefault(),a>=0&&a<i.length&&(async()=>await v(a))()))}async function v(t){const n=i[t],s=n==null?void 0:n.url;s&&(await B(n),window.open(s,"_blank"),g())}function E(t){r&&!r.contains(t.target)&&g()}typeof window<"u"&&(window.onInputAsync=D);
