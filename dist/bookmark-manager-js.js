class k{constructor(){this.bookmarks=[],this.filteredBookmarks=[],this.currentFolder=null,this.searchInput=document.getElementById("searchInput"),this.bookmarkTree=document.getElementById("bookmarkTree"),this.folderTree=document.getElementById("folderTree"),this.panelTitle=document.getElementById("panelTitle"),this.backButton=document.getElementById("backButton"),this.showHidden=!0,this.currentFilter="all",this.giteeConfig={owner:"",repo:"",token:"",branch:"master",filePath:"hidden-bookmarks.json"},this.init()}async init(){await this.loadConfigFromIndexedDB(),await this.loadBookmarks(),this.setupEventListeners(),this.renderFolderTree(),this.updateStats(),this.applyFilter("all"),this.selectRootFolder(),this.renderBookmarks()}async loadBookmarks(){try{if(this.giteeConfig&&this.giteeConfig.owner&&this.giteeConfig.repo&&this.giteeConfig.token)try{const i=await this.loadBookmarksFromGitee();if(i&&i.length>0){this.bookmarks=i,this.saveBookmarksToStorage();return}}catch{}if(typeof chrome<"u"&&chrome.bookmarks){const i=await chrome.bookmarks.getTree();this.bookmarks=i[0].children||[],this.saveBookmarksToStorage()}else this.bookmarks=[{id:"1",title:"示例文件夹",children:[{id:"2",title:"Google",url:"https://www.google.com"},{id:"3",title:"GitHub",url:"https://github.com"}]}],this.saveBookmarksToStorage()}catch{this.bookmarks=[]}}saveBookmarksToStorage(){typeof chrome<"u"&&chrome.storage&&chrome.storage.local.set({bookmarkManagerData:this.bookmarks},()=>{})}setupEventListeners(){this.searchInput.addEventListener("input",i=>{this.filterBookmarks(i.target.value)}),document.getElementById("filterSelect").addEventListener("change",i=>{this.applyFilter(i.target.value)}),document.getElementById("refreshBtn").addEventListener("click",()=>{this.loadBookmarks().then(()=>{this.renderFolderTree(),this.renderBookmarks(),this.updateStats()})}),document.getElementById("addBookmarkBtn").addEventListener("click",()=>{this.addBookmark()}),document.getElementById("exportBtn").addEventListener("click",()=>{this.exportBookmarks()}),document.getElementById("configBtn").addEventListener("click",()=>{this.showConfigModal()}),document.getElementById("closeConfigModal").addEventListener("click",()=>{this.hideConfigModal()}),document.getElementById("cancelConfigBtn").addEventListener("click",()=>{this.hideConfigModal()}),document.getElementById("saveConfigBtn").addEventListener("click",()=>{this.saveConfig()}),this.backButton.addEventListener("click",i=>{i.preventDefault(),console.log("返回按钮被点击");const e=this.backButton.getAttribute("data-parent-id");console.log("父目录ID:",e),e&&(this.selectFolder(e),this.syncLeftSidebarSelection(e))}),this.folderTree.addEventListener("click",i=>{const e=i.target;if(e.classList.contains("folder-toggle")){const t=e.parentElement.nextElementSibling;t&&(t.style.display=t.style.display==="none"?"block":"none",e.textContent=e.textContent==="▼"?"▶":"▼")}if(e.classList.contains("folder-item")||e.closest(".folder-item")){const o=(e.classList.contains("folder-item")?e:e.closest(".folder-item")).getAttribute("data-folder-id");o&&this.selectFolder(o)}}),this.bookmarkTree.addEventListener("click",i=>{const e=i.target;if(e.classList.contains("action-btn-edit")){i.stopPropagation();const t=e.getAttribute("data-bookmark-id");t&&this.editBookmark(t);return}if(e.classList.contains("action-btn-hide")){i.stopPropagation();const t=e.getAttribute("data-bookmark-id");t&&this.toggleBookmarkVisibility(t);return}if(e.classList.contains("action-btn-delete")){i.stopPropagation();const t=e.getAttribute("data-bookmark-id");t&&this.deleteBookmark(t);return}if(e.classList.contains("script-bookmark")||e.closest(".script-bookmark")){i.stopPropagation();const t=e.classList.contains("script-bookmark")?e:e.closest(".script-bookmark"),o=decodeURIComponent(t.getAttribute("data-script-url"));this.executeScript(o);return}if(e.classList.contains("folder-item")||e.closest(".folder-item")){const o=(e.classList.contains("folder-item")?e:e.closest(".folder-item")).getAttribute("data-folder-id");o&&(this.selectFolder(o),this.syncLeftSidebarSelection(o))}})}filterBookmarks(i){this.renderBookmarks(),this.renderFolderTree()}applyFilter(i){switch(this.currentFilter=i,i){case"all":this.filteredBookmarks=this.bookmarks;break;case"visible":this.filteredBookmarks=this.filterVisibleBookmarks(this.bookmarks);break;case"hidden":this.filteredBookmarks=this.filterHiddenOnlyBookmarks(this.bookmarks);break}this.renderFolderTree(),this.renderBookmarks(),this.updateStats()}searchInBookmarks(i,e){const t=[];for(const o of i)if(o.children){const r=this.searchInBookmarks(o.children,e);r.length>0&&t.push({...o,children:r})}else o.url&&(o.title.toLowerCase().includes(e)||o.url.toLowerCase().includes(e))&&t.push(o);return t}renderFolderTree(){const i=this.getFolders(this.bookmarks);this.folderTree.innerHTML=this.renderFolderList(i)}getFolders(i){const e=[],t=this.searchInput.value.trim();for(const o of i)if(o.children){const r=this.getFolders(o.children);if(t&&!this.hasSearchResults(o,t.toLowerCase()))continue;if(this.currentFilter==="hidden"){if(!(o.hidden||this.hasHiddenContent(o.children)))continue}else if(this.currentFilter==="visible"&&o.hidden)continue;e.push({id:o.id,title:o.title,hidden:o.hidden||!1,children:r})}return e}hasHiddenContent(i){for(const e of i)if(e.hidden||e.children&&this.hasHiddenContent(e.children))return!0;return!1}hasSearchResults(i,e){if(i.title.toLowerCase().includes(e))return!0;if(i.children){for(const t of i.children)if(this.hasSearchResults(t,e))return!0}return!1}getFaviconUrl(i){try{const t=new URL(i).hostname;return[`https://www.google.com/s2/favicons?domain=${t}&sz=16`,`https://favicons.githubusercontent.com/${t}`,`https://${t}/favicon.ico`,`https://${t}/favicon.png`,`https://${t}/apple-touch-icon.png`][0]}catch{return"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgMkgxNFYxNEgyVjJaIiBzdHJva2U9IiM2NjYiIHN0cm9rZS13aWR0aD0iMS41IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9Ik0yIDZIMTRWNkg2VjJaIiBmaWxsPSIjNjY2Ii8+Cjwvc3ZnPgo="}}executeScript(i){if(i.startsWith("javascript:")){const e=i.substring(11);try{const t=window.open("","_blank");t&&(t.document.write(`
            <html>
              <head><title>脚本执行</title></head>
              <body>
                <h3>脚本执行结果：</h3>
                <div id="result"></div>
                <script>
                  try {
                    const result = ${e};
                    document.getElementById('result').innerHTML = '<pre>' + JSON.stringify(result, null, 2) + '</pre>';
                  } catch (error) {
                    document.getElementById('result').innerHTML = '<p style="color: red;">执行错误: ' + error.message + '</p>';
                  }
                <\/script>
              </body>
            </html>
          `),t.document.close())}catch(t){alert("脚本执行失败: "+t.message)}}else i.startsWith("data:")&&window.open(i,"_blank")}renderFolderList(i,e=0){let t="";for(const o of i){const r=o.hidden||!1,n=r?"👁️‍🗨️":"",s=r?" hidden-folder":"",a=o.children&&o.children.length>0;t+=`
        <div class="folder-item${s}" data-folder-id="${o.id}" style="padding-left: ${16+e*16}px;">
          ${a?'<div class="folder-toggle">▼</div>':'<div class="folder-toggle" style="visibility: hidden;">▼</div>'}
          <div class="folder-icon">📁</div>
          <div class="folder-name">${o.title} ${n}</div>
        </div>
        ${a?`
          <div class="folder-children" style="display: block;">
            ${this.renderFolderList(o.children,e+1)}
          </div>
        `:""}
      `}return t}selectRootFolder(){const i=this.bookmarks.find(e=>e.title==="书签栏"||e.title==="Bookmarks bar");i?this.selectFolder(i.id):this.bookmarks.length>0&&this.selectFolder(this.bookmarks[0].id)}selectFolder(i){document.querySelectorAll(".folder-item").forEach(o=>{o.classList.remove("active")});const e=document.querySelector(`[data-folder-id="${i}"]`);e&&e.classList.add("active");const t=this.findFolderById(this.bookmarks,i);if(t){this.currentFolder=t,this.panelTitle.textContent=t.title;const o=this.searchInput.value.trim();o?this.renderSearchResultsInFolder(t,o):this.renderBookmarks()}}syncLeftSidebarSelection(i){document.querySelectorAll(".sidebar .folder-item").forEach(t=>{t.classList.remove("active")});const e=document.querySelector(`.sidebar [data-folder-id="${i}"]`);e&&(e.classList.add("active"),this.ensureParentFoldersExpanded(e))}ensureParentFoldersExpanded(i){var t;let e=i.parentElement;for(;e&&e!==this.folderTree;){if(e.classList.contains("folder-children")){e.style.display="block";const o=(t=e.previousElementSibling)==null?void 0:t.querySelector(".folder-toggle");o&&(o.textContent="▼")}e=e.parentElement}}findFolderById(i,e){for(const t of i){if(t.id===e)return t;if(t.children){const o=this.findFolderById(t.children,e);if(o)return o}}return null}findParentFolder(i,e,t=null){for(const o of i){if(o.id===e)return t;if(o.children){const r=this.findParentFolder(o.children,e,o);if(r!==null)return r}}return null}renderBookmarks(){const i=this.searchInput.value.trim();if(i){this.renderSearchResults(i);return}if(!this.currentFolder){this.bookmarkTree.innerHTML=`
        <div class="empty-state">
          <h3>选择一个文件夹</h3>
          <p>从左侧选择一个文件夹来查看其中的书签</p>
        </div>
      `;return}const e=this.findParentFolder(this.bookmarks,this.currentFolder.id);e?(this.backButton.style.display="flex",this.backButton.setAttribute("data-parent-id",e.id),this.backButton.querySelector(".back-text").textContent=`返回 ${e.title}`):this.backButton.style.display="none";const t=this.findFolderById(this.bookmarks,this.currentFolder.id);if(!t){this.bookmarkTree.innerHTML=`
        <div class="empty-state">
          <h3>文件夹不存在</h3>
          <p>此文件夹可能已被删除</p>
        </div>
      `;return}this.currentFolder=t;const o=this.currentFolder.children||[];if(o.length===0){this.bookmarkTree.innerHTML=`
        <div class="empty-state">
          <h3>文件夹为空</h3>
          <p>此文件夹中没有书签</p>
        </div>
      `;return}let r=o;switch(this.currentFilter){case"visible":r=this.filterVisibleBookmarks(o);break;case"hidden":r=this.filterHiddenOnlyBookmarks(o);break;case"all":default:r=o;break}if(r.length===0){this.bookmarkTree.innerHTML=`
        <div class="empty-state">
          <h3>没有匹配的书签</h3>
          <p>当前筛选条件下没有找到书签</p>
        </div>
      `;return}this.bookmarkTree.innerHTML=this.renderBookmarkList(r)}renderSearchResults(i){var r;const e=((r=this.bookmarks[0])==null?void 0:r.children)||[];let t=e;switch(this.currentFilter){case"visible":t=this.filterVisibleBookmarks(e);break;case"hidden":t=this.filterHiddenOnlyBookmarks(e);break;case"all":default:t=e;break}const o=this.searchInBookmarks(t,i.toLowerCase());if(o.length===0){this.bookmarkTree.innerHTML=`
        <div class="empty-state">
          <h3>没有找到匹配的书签</h3>
          <p>搜索 "${i}" 没有找到结果</p>
        </div>
      `,document.querySelectorAll(".folder-item").forEach(n=>{n.classList.remove("active")}),this.panelTitle.textContent="搜索结果";return}this.bookmarkTree.innerHTML=this.renderSearchResultsList(o,i),this.panelTitle.textContent=`搜索结果 (${o.length} 项)`,document.querySelectorAll(".folder-item").forEach(n=>{n.classList.remove("active")})}renderSearchResultsList(i,e){let t="";for(const o of i)if(o.url){const r=o.hidden||!1,n=r?" hidden-bookmark":"",s=r?"👁️‍🗨️":"",a=o.url.startsWith("javascript:"),l=o.url.startsWith("data:");let d,c,h;a||l?(d="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgMkgxNFYxNEgyVjJaIiBzdHJva2U9IiM2NjYiIHN0cm9rZS13aWR0aD0iMS41IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9Ik0yIDZIMTRWNkg2VjJaIiBmaWxsPSIjNjY2Ii8+Cjwvc3ZnPgo=",c="脚本书签",h=`data-script-url="${encodeURIComponent(o.url)}" class="script-bookmark"`):(d=this.getFaviconUrl(o.url),c=o.url,h=`href="${o.url}" target="_blank"`),t+=`
          <div class="bookmark-item${n}">
            <img class="bookmark-icon" src="${d}" alt="书签" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgMkgxNFYxNEgyVjJaIiBzdHJva2U9IiM2NjYiIHN0cm9rZS13aWR0aD0iMS41IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9Ik0yIDZIMTRWNkg2VjJaIiBmaWxsPSIjNjY2Ii8+Cjwvc3ZnPgo='">
            <div class="bookmark-content">
              <a ${h} class="bookmark-title">${this.highlightSearchTerm(o.title,e)} ${s}</a>
              <div class="bookmark-url">${c}</div>
              <div class="bookmark-actions">
                <button class="action-btn action-btn-edit" data-bookmark-id="${o.id}">编辑</button>
                <button class="action-btn action-btn-hide" data-bookmark-id="${o.id}">${r?"显示":"隐藏"}</button>
                <button class="action-btn action-btn-delete" data-bookmark-id="${o.id}">删除</button>
              </div>
            </div>
          </div>
        `}else o.children&&(t+=this.renderSearchResultsList(o.children,e));return t}highlightSearchTerm(i,e){if(!e)return i;const t=new RegExp(`(${e})`,"gi");return i.replace(t,"<mark>$1</mark>")}renderSearchResultsInFolder(i,e){const t=this.searchInBookmarks(i.children||[],e.toLowerCase());if(t.length===0){this.bookmarkTree.innerHTML=`
        <div class="empty-state">
          <h3>该目录中没有匹配的书签</h3>
          <p>在 "${i.title}" 中没有找到包含 "${e}" 的书签</p>
        </div>
      `,this.panelTitle.textContent=`${i.title} - 搜索结果 (0 项)`;return}this.bookmarkTree.innerHTML=this.renderSearchResultsList(t,e),this.panelTitle.textContent=`${i.title} - 搜索结果 (${t.length} 项)`}renderBookmarkList(i){let e="";for(const t of i){const o=t.hidden||!1;if(t.url){const r=o?" hidden-bookmark":"",n=o?"👁️‍🗨️":"",s=t.url.startsWith("javascript:"),a=t.url.startsWith("data:");let l,d,c;s||a?(l="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgMkgxNFYxNEgyVjJaIiBzdHJva2U9IiM2NjYiIHN0cm9rZS13aWR0aD0iMS41IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9Ik0yIDZIMTRWNkg2VjJaIiBmaWxsPSIjNjY2Ii8+Cjwvc3ZnPgo=",d="脚本书签",c=`data-script-url="${encodeURIComponent(t.url)}" class="script-bookmark"`):(l=this.getFaviconUrl(t.url),d=t.url,c=`href="${t.url}" target="_blank"`),e+=`
          <div class="bookmark-item${r}">
            <img class="bookmark-icon" src="${l}" alt="书签" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgMkgxNFYxNEgyVjJaIiBzdHJva2U9IiM2NjYiIHN0cm9rZS13aWR0aD0iMS41IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9Ik0yIDZIMTRWNkg2VjJaIiBmaWxsPSIjNjY2Ii8+Cjwvc3ZnPgo='">
            <div class="bookmark-content">
              <a ${c} class="bookmark-title">${t.title} ${n}</a>
              <div class="bookmark-url">${d}</div>
              <div class="bookmark-actions">
                <button class="action-btn action-btn-edit" data-bookmark-id="${t.id}">编辑</button>
                <button class="action-btn action-btn-hide" data-bookmark-id="${t.id}">${o?"显示":"隐藏"}</button>
                <button class="action-btn action-btn-delete" data-bookmark-id="${t.id}">删除</button>
              </div>
            </div>
          </div>
        `}else if(t.children){const r=o?" hidden-bookmark":"",n=o?"👁️‍🗨️":"";e+=`
          <div class="bookmark-item folder-item${r}" data-folder-id="${t.id}">
            <div class="folder-icon">📁</div>
            <div class="bookmark-content">
              <div class="bookmark-title">${t.title} ${n}</div>
              <div class="bookmark-url">文件夹 (${t.children.length} 项)</div>
              <div class="bookmark-actions">
                <button class="action-btn action-btn-edit" data-bookmark-id="${t.id}">编辑</button>
                <button class="action-btn action-btn-hide" data-bookmark-id="${t.id}">${o?"显示":"隐藏"}</button>
                <button class="action-btn action-btn-delete" data-bookmark-id="${t.id}">删除</button>
              </div>
            </div>
          </div>
        `}}return e}updateStats(){const i=this.calculateStats(this.bookmarks);document.getElementById("totalBookmarks").textContent=i.totalBookmarks,document.getElementById("totalFolders").textContent=i.totalFolders,document.getElementById("recentBookmarks").textContent=i.recentBookmarks}calculateStats(i){let e=0,t=0,o=0;const r=Date.now()-7*24*60*60*1e3,n=s=>{for(const a of s)a.children?(t++,n(a.children)):a.url&&(e++,a.dateAdded&&a.dateAdded>r&&o++)};return n(i),{totalBookmarks:e,totalFolders:t,recentBookmarks:o}}addBookmark(){const i=prompt("请输入书签标题:");if(!i)return;const e=prompt("请输入书签URL:");if(e)try{typeof chrome<"u"&&chrome.bookmarks?chrome.bookmarks.create({title:i,url:e},()=>{this.loadBookmarks().then(()=>{this.renderFolderTree(),this.renderBookmarks(),this.updateStats()})}):alert("书签添加功能需要浏览器扩展环境")}catch{alert("添加书签失败")}}editBookmark(i){alert("编辑功能待实现")}deleteBookmark(i){if(confirm("确定要删除这个书签吗？"))try{typeof chrome<"u"&&chrome.bookmarks?chrome.bookmarks.remove(i,()=>{this.loadBookmarks().then(()=>{this.renderFolderTree(),this.renderBookmarks(),this.updateStats()})}):alert("书签删除功能需要浏览器扩展环境")}catch{alert("删除书签失败")}}exportBookmarks(){const i=JSON.stringify(this.bookmarks,null,2),e=new Blob([i],{type:"application/json"}),t=URL.createObjectURL(e),o=document.createElement("a");o.href=t,o.download="bookmarks.json",o.click(),URL.revokeObjectURL(t)}findBookmarkById(i){const e=t=>{for(const o of t){if(o.id===i)return o;if(o.children){const r=e(o.children);if(r)return r}}return null};return e(this.bookmarks)}toggleBookmarkVisibility(i){const e=this.findBookmarkById(i);e&&(e.hidden=!e.hidden,e.children&&e.children.length>0&&this.toggleFolderVisibility(e,e.hidden),this.saveBookmarkTreeToGitee(this.bookmarks),this.saveBookmarksToStorage(),this.updateSystemBookmarks(),this.renderFolderTree(),this.renderBookmarks(),this.updateStats())}toggleFolderVisibility(i,e){if(i.hidden=e,i.children&&i.children.length>0)for(const t of i.children)t.hidden=e,t.children&&t.children.length>0&&this.toggleFolderVisibility(t,e)}updateSystemBookmarks(){if(typeof chrome<"u"&&chrome.bookmarks){const i=this.filterVisibleBookmarks(this.bookmarks[0].children);this.removeAllBookmarks().then(()=>{this.createBookmarks(i,"1").then(()=>{})}).catch(e=>{})}}removeAllBookmarks(){return new Promise(i=>{chrome.bookmarks.getTree(e=>{var n;const t=((n=e[0])==null?void 0:n.children)||[];let o=[];t.forEach(s=>{s.children&&s.children.length&&s.children.forEach(a=>o.push(a.id))});let r=o.length;if(r===0)return i();o.forEach(s=>{chrome.bookmarks.removeTree(s,()=>{r--,r===0&&i()})})})})}filterVisibleBookmarks(i){return Array.isArray(i)?i.filter(e=>{if(!e||e.hidden===!0)return!1;if(e.children&&Array.isArray(e.children)){const t=this.filterVisibleBookmarks(e.children);if(t.length>0)e.children=t;else return!1}return!0}):[]}createBookmarks(i,e="1"){return!Array.isArray(i)||i.length===0?Promise.resolve():Promise.all(i.map(t=>t?t.url?new Promise(o=>{chrome.bookmarks.create({parentId:e,title:t.title,url:t.url},r=>{chrome.runtime.lastError,o(void 0)})}):new Promise(o=>{chrome.bookmarks.create({parentId:e,title:t.title},r=>{chrome.runtime.lastError?o(void 0):t.children&&t.children.length>0?this.createBookmarks(t.children,r.id).then(()=>o(void 0)):o(void 0)})}):Promise.resolve())).then(()=>{})}loadBookmarksFromGitee(){return new Promise((i,e)=>{if(!this.giteeConfig||!this.giteeConfig.owner||!this.giteeConfig.repo||!this.giteeConfig.token){e(new Error("Gitee配置不完整"));return}const t=`https://gitee.com/api/v5/repos/${this.giteeConfig.owner}/${this.giteeConfig.repo}/contents/${this.giteeConfig.filePath}`;fetch(t,{method:"GET",headers:{Authorization:`token ${this.giteeConfig.token}`}}).then(o=>o.json()).then(o=>{if(o.content){const r=decodeURIComponent(escape(atob(o.content))),n=JSON.parse(r);i(n)}else e(new Error("无法获取文件内容"))}).catch(o=>{e(o)})})}filterHiddenBookmarks(i){const e=t=>t.filter(o=>o.hidden?!1:(o.children&&(o.children=e(o.children)),!0));return e(i)}filterVisibleBookmarks(i){const e=t=>t.filter(o=>{if(o.hidden)return!1;if(o.children){const r=e(o.children);return r.length>0?{...o,children:r}:!1}return!0});return e(i)}filterHiddenOnlyBookmarks(i){const e=t=>t.filter(o=>{if(o.hidden)return!0;if(o.children&&o.children.length>0){const r=e(o.children);return o.hidden||r.length>0?{...o,children:r}:!1}return!1});return e(i)}saveBookmarkTreeToGitee(i){if(!this.giteeConfig||!this.giteeConfig.owner||!this.giteeConfig.repo||!this.giteeConfig.token)return;const e=JSON.stringify(i,null,2),t=btoa(unescape(encodeURIComponent(e)));this.getFileSha().then(o=>{const r=`https://gitee.com/api/v5/repos/${this.giteeConfig.owner}/${this.giteeConfig.repo}/contents/${this.giteeConfig.filePath}`;fetch(r,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`token ${this.giteeConfig.token}`},body:JSON.stringify({message:"更新书签树 - 隐藏属性",content:t,sha:o})}).then(n=>n.json()).then(n=>{n.content}).catch(n=>{})})}async openDB(){return new Promise((i,e)=>{const t=indexedDB.open("bookmarks-plus",1);t.onupgradeneeded=function(o){const r=o.target.result;r.objectStoreNames.contains("gitee-config")||r.createObjectStore("gitee-config")},t.onsuccess=function(o){i(o.target.result)},t.onerror=function(o){e(o)}})}async getConfigFromIndexedDB(i){const e=await this.openDB();return new Promise(t=>{const r=e.transaction("gitee-config","readonly").objectStore("gitee-config"),n={};let s=i.length;i.forEach(a=>{const l=r.get(a);l.onsuccess=function(){n[a]=l.result||"",s--,s===0&&t(n)},l.onerror=function(){s--,s===0&&t(n)}})})}async setConfigToIndexedDB(i){const t=(await this.openDB()).transaction("gitee-config","readwrite"),o=t.objectStore("gitee-config");return Object.entries(i).forEach(([r,n])=>o.put(n,r)),new Promise(r=>{t.oncomplete=()=>r(),t.onerror=()=>r()})}async loadConfigFromIndexedDB(){const i=["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"],e=await this.getConfigFromIndexedDB(i);this.giteeConfig.owner=e.giteeOwner||"",this.giteeConfig.repo=e.giteeRepo||"",this.giteeConfig.token=e.giteeToken||"",this.giteeConfig.branch=e.giteeBranch||"master",this.giteeConfig.filePath=e.giteeFilePath||"hidden-bookmarks.json"}async getFileSha(){try{const i=`https://gitee.com/api/v5/repos/${this.giteeConfig.owner}/${this.giteeConfig.repo}/contents/${this.giteeConfig.filePath}?ref=${this.giteeConfig.branch}`,e=await fetch(i,{headers:{Authorization:`token ${this.giteeConfig.token}`}});if(e.ok)return(await e.json()).sha}catch{}return null}showConfigModal(){const i=document.getElementById("configModal");i.style.display="flex",document.getElementById("giteeOwner").value=this.giteeConfig.owner,document.getElementById("giteeRepo").value=this.giteeConfig.repo,document.getElementById("giteeToken").value=this.giteeConfig.token}hideConfigModal(){const i=document.getElementById("configModal");i.style.display="none"}async saveConfig(){const i=document.getElementById("giteeOwner").value.trim(),e=document.getElementById("giteeRepo").value.trim(),t=document.getElementById("giteeToken").value.trim();if(!i||!e||!t){alert("请填写完整的配置信息");return}this.giteeConfig.owner=i,this.giteeConfig.repo=e,this.giteeConfig.token=t;try{await this.setConfigToIndexedDB({giteeOwner:i,giteeRepo:e,giteeToken:t,giteeBranch:this.giteeConfig.branch,giteeFilePath:this.giteeConfig.filePath})}catch{}this.hideConfigModal(),alert("配置已保存！")}}document.addEventListener("DOMContentLoaded",()=>{window.bookmarkManager=new k});
