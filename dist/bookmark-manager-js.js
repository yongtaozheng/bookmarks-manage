class f{constructor(){this.bookmarks=[],this.filteredBookmarks=[],this.currentFolder=null,this.searchInput=document.getElementById("searchInput"),this.bookmarkTree=document.getElementById("bookmarkTree"),this.folderTree=document.getElementById("folderTree"),this.panelTitle=document.getElementById("panelTitle"),this.backButton=document.getElementById("backButton"),this.showHidden=!0,this.currentFilter="all",this.draggedElement=null,this.dragOverElement=null,this.giteeConfig={owner:"",repo:"",token:"",branch:"master",filePath:"hidden-bookmarks.json"},this.init()}async init(){await this.loadConfigFromIndexedDB(),await this.loadBookmarks(),this.setupEventListeners(),this.renderFolderTree(),this.updateStats(),this.applyFilter("all"),this.selectRootFolder(),this.renderBookmarks()}async loadBookmarks(){try{if(this.giteeConfig&&this.giteeConfig.owner&&this.giteeConfig.repo&&this.giteeConfig.token)try{const t=await this.loadBookmarksFromGitee();if(t&&t.length>0){this.bookmarks=t,this.saveBookmarksToStorage();return}}catch{}if(typeof chrome<"u"&&chrome.bookmarks){const t=await chrome.bookmarks.getTree();this.bookmarks=t[0].children||[],this.saveBookmarksToStorage()}else this.bookmarks=[{id:"1",title:"ç¤ºä¾‹æ–‡ä»¶å¤¹",children:[{id:"2",title:"Google",url:"https://www.google.com"},{id:"3",title:"GitHub",url:"https://github.com"}]}],this.saveBookmarksToStorage()}catch{this.bookmarks=[]}}saveBookmarksToStorage(){typeof chrome<"u"&&chrome.storage&&chrome.storage.local.set({bookmarkManagerData:this.bookmarks},()=>{})}setupEventListeners(){this.searchInput.addEventListener("input",t=>{this.filterBookmarks(t.target.value)}),document.getElementById("filterSelect").addEventListener("change",t=>{this.applyFilter(t.target.value)}),document.getElementById("refreshBtn").addEventListener("click",()=>{this.loadBookmarks().then(()=>{this.renderFolderTree(),this.renderBookmarks(),this.updateStats()})}),document.getElementById("addBookmarkBtn").addEventListener("click",()=>{this.addBookmark()}),document.getElementById("exportBtn").addEventListener("click",()=>{this.exportBookmarks()}),document.getElementById("configBtn").addEventListener("click",()=>{this.showConfigModal()}),document.getElementById("closeConfigModal").addEventListener("click",()=>{this.hideConfigModal()}),document.getElementById("cancelConfigBtn").addEventListener("click",()=>{this.hideConfigModal()}),document.getElementById("saveConfigBtn").addEventListener("click",()=>{this.saveConfig()}),this.backButton.addEventListener("click",t=>{t.preventDefault();const e=this.backButton.getAttribute("data-parent-id");e&&(this.selectFolder(e),this.syncLeftSidebarSelection(e))}),this.setupDragAndDrop(),this.folderTree.addEventListener("click",t=>{const e=t.target;if(e.classList.contains("folder-toggle")){const r=e.parentElement.nextElementSibling;r&&(r.style.display=r.style.display==="none"?"block":"none",e.textContent=e.textContent==="â–¼"?"â–¶":"â–¼")}if(e.classList.contains("folder-item")||e.closest(".folder-item")){const i=(e.classList.contains("folder-item")?e:e.closest(".folder-item")).getAttribute("data-folder-id");i&&this.selectFolder(i)}}),this.bookmarkTree.addEventListener("click",t=>{const e=t.target;if(!e.classList.contains("drag-handle")){if(e.classList.contains("action-btn-edit")){t.stopPropagation();const r=e.getAttribute("data-bookmark-id");r&&this.editBookmark(r);return}if(e.classList.contains("action-btn-hide")){t.stopPropagation();const r=e.getAttribute("data-bookmark-id");r&&this.toggleBookmarkVisibility(r);return}if(e.classList.contains("action-btn-delete")){t.stopPropagation();const r=e.getAttribute("data-bookmark-id");r&&this.deleteBookmark(r);return}if(e.classList.contains("script-bookmark")||e.closest(".script-bookmark")){t.stopPropagation();const r=e.classList.contains("script-bookmark")?e:e.closest(".script-bookmark"),i=decodeURIComponent(r.getAttribute("data-script-url"));this.executeScript(i);return}if((e.classList.contains("folder-item")||e.closest(".folder-item"))&&!e.classList.contains("drag-handle")){const i=(e.classList.contains("folder-item")?e:e.closest(".folder-item")).getAttribute("data-folder-id");i&&(this.selectFolder(i),this.syncLeftSidebarSelection(i))}}})}setupDragAndDrop(){this.bookmarkTree.addEventListener("dragstart",t=>{const e=t.target.closest(".bookmark-item");e&&(this.resetDragState(),this.draggedElement=e,e.classList.add("dragging"),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/html",e.outerHTML))}),this.bookmarkTree.addEventListener("dragend",t=>{const e=t.target.closest(".bookmark-item");e&&(e.classList.remove("dragging"),this.draggedElement=null,this.dragOverElement=null,this.clearDragOverClasses())}),this.bookmarkTree.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="move";const e=t.target.closest(".bookmark-item");if(e&&e!==this.draggedElement){this.clearDragOverClasses(),this.dragOverElement=e;const r=e.getBoundingClientRect(),i=r.top+r.height/2;t.clientY<i?e.classList.add("drag-over"):e.classList.add("drag-over-bottom")}}),this.bookmarkTree.addEventListener("dragleave",t=>{t.target.closest(".bookmark-item")||this.clearDragOverClasses()}),this.bookmarkTree.addEventListener("drop",t=>{t.preventDefault(),this.draggedElement&&this.dragOverElement&&this.handleDrop(this.draggedElement,this.dragOverElement,t),this.draggedElement=null,this.dragOverElement=null,this.clearDragOverClasses()})}resetDragState(){this.draggedElement=null,this.dragOverElement=null,this.clearDragOverClasses(),this.bookmarkTree.querySelectorAll(".bookmark-item").forEach(e=>{e.classList.remove("dragging","drag-over","drag-over-bottom")})}clearDragOverClasses(){this.bookmarkTree.querySelectorAll(".bookmark-item").forEach(e=>{e.classList.remove("drag-over","drag-over-bottom")}),this.dragOverElement=null}handleDrop(t,e,r){const i=t.getAttribute("data-bookmark-id"),o=e.getAttribute("data-bookmark-id");if(i===o)return;const n=this.findFolderById(this.bookmarks,this.currentFolder.id);if(!n||!n.children)return;const s=n.children,a=s.findIndex(k=>k.id===i),d=s.findIndex(k=>k.id===o);if(a===-1||d===-1)return;const l=e.getBoundingClientRect(),c=l.top+l.height/2,h=r.clientY<c?d:d+1,m=s.splice(a,1)[0],g=h>a?h-1:h;s.splice(g,0,m),this.updateBookmarkOrder(i,o,h>d),this.saveBookmarksToStorage(),setTimeout(()=>{this.renderBookmarks()},50)}async updateBookmarkOrder(t,e,r){try{const i=this.currentFolder.id,o=this.findFolderById(this.bookmarks,this.currentFolder.id);if(!o||!o.children)return;const s=o.children.findIndex(d=>d.id===e);if(s===-1)return;const a=r?s+1:s;await chrome.bookmarks.move(t,{parentId:i,index:a})}catch(i){console.error("æ›´æ–°ä¹¦ç­¾é¡ºåºå¤±è´¥:",i)}}findBookmarkById(t,e){for(const r of t){if(r.id===e)return r;if(r.children){const i=this.findBookmarkById(r.children,e);if(i)return i}}return null}getBookmarkIndex(t){const e=this.findFolderById(this.bookmarks,this.currentFolder.id);return!e||!e.children?0:e.children.findIndex(r=>r.id===t)}filterBookmarks(t){this.renderBookmarks(),this.renderFolderTree()}applyFilter(t){switch(this.currentFilter=t,t){case"all":this.filteredBookmarks=this.bookmarks;break;case"visible":this.filteredBookmarks=this.filterVisibleBookmarks(this.bookmarks);break;case"hidden":this.filteredBookmarks=this.filterHiddenOnlyBookmarks(this.bookmarks);break}this.renderFolderTree(),this.renderBookmarks(),this.updateStats()}searchInBookmarks(t,e){const r=[];for(const i of t)if(i.children){const o=this.searchInBookmarks(i.children,e);o.length>0&&r.push({...i,children:o})}else i.url&&(i.title.toLowerCase().includes(e)||i.url.toLowerCase().includes(e))&&r.push(i);return r}renderFolderTree(){const t=this.getFolders(this.bookmarks);this.folderTree.innerHTML=this.renderFolderList(t)}getFolders(t){const e=[],r=this.searchInput.value.trim();for(const i of t)if(i.children){const o=this.getFolders(i.children);if(r&&!this.hasSearchResults(i,r.toLowerCase()))continue;if(this.currentFilter==="hidden"){if(!(i.hidden||this.hasHiddenContent(i.children)))continue}else if(this.currentFilter==="visible"&&i.hidden)continue;e.push({id:i.id,title:i.title,hidden:i.hidden||!1,children:o})}return e}hasHiddenContent(t){for(const e of t)if(e.hidden||e.children&&this.hasHiddenContent(e.children))return!0;return!1}hasSearchResults(t,e){if(t.title.toLowerCase().includes(e))return!0;if(t.children){for(const r of t.children)if(this.hasSearchResults(r,e))return!0}return!1}getFaviconUrl(t){try{const r=new URL(t).hostname;return[`https://www.google.com/s2/favicons?domain=${r}&sz=16`,`https://favicons.githubusercontent.com/${r}`,`https://${r}/favicon.ico`,`https://${r}/favicon.png`,`https://${r}/apple-touch-icon.png`][0]}catch{return"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgMkgxNFYxNEgyVjJaIiBzdHJva2U9IiM2NjYiIHN0cm9rZS13aWR0aD0iMS41IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9Ik0yIDZIMTRWNkg2VjJaIiBmaWxsPSIjNjY2Ii8+Cjwvc3ZnPgo="}}executeScript(t){if(t.startsWith("javascript:")){const e=t.substring(11);try{const r=window.open("","_blank");r&&(r.document.write(`
            <html>
              <head><title>è„šæœ¬æ‰§è¡Œ</title></head>
              <body>
                <h3>è„šæœ¬æ‰§è¡Œç»“æœï¼š</h3>
                <div id="result"></div>
                <script>
                  try {
                    const result = ${e};
                    document.getElementById('result').innerHTML = '<pre>' + JSON.stringify(result, null, 2) + '</pre>';
                  } catch (error) {
                    document.getElementById('result').innerHTML = '<p style="color: red;">æ‰§è¡Œé”™è¯¯: ' + error.message + '</p>';
                  }
                <\/script>
              </body>
            </html>
          `),r.document.close())}catch(r){alert("è„šæœ¬æ‰§è¡Œå¤±è´¥: "+r.message)}}else t.startsWith("data:")&&window.open(t,"_blank")}renderFolderList(t,e=0){let r="";for(const i of t){const o=i.hidden||!1,n=o?"ğŸ‘ï¸â€ğŸ—¨ï¸":"",s=o?" hidden-folder":"",a=i.children&&i.children.length>0;r+=`
        <div class="folder-item${s}" data-folder-id="${i.id}" style="padding-left: ${16+e*16}px;">
          ${a?'<div class="folder-toggle">â–¼</div>':'<div class="folder-toggle" style="visibility: hidden;">â–¼</div>'}
          <div class="folder-icon">ğŸ“</div>
          <div class="folder-name">${i.title} ${n}</div>
        </div>
        ${a?`
          <div class="folder-children" style="display: block;">
            ${this.renderFolderList(i.children,e+1)}
          </div>
        `:""}
      `}return r}selectRootFolder(){const t=this.bookmarks.find(e=>e.title==="ä¹¦ç­¾æ "||e.title==="Bookmarks bar");t?this.selectFolder(t.id):this.bookmarks.length>0&&this.selectFolder(this.bookmarks[0].id)}selectFolder(t){document.querySelectorAll(".folder-item").forEach(i=>{i.classList.remove("active")});const e=document.querySelector(`[data-folder-id="${t}"]`);e&&e.classList.add("active");const r=this.findFolderById(this.bookmarks,t);if(r){this.currentFolder=r,this.panelTitle.textContent=r.title;const i=this.searchInput.value.trim();i?this.renderSearchResultsInFolder(r,i):this.renderBookmarks()}}syncLeftSidebarSelection(t){document.querySelectorAll(".sidebar .folder-item").forEach(r=>{r.classList.remove("active")});const e=document.querySelector(`.sidebar [data-folder-id="${t}"]`);e&&(e.classList.add("active"),this.ensureParentFoldersExpanded(e))}ensureParentFoldersExpanded(t){var r;let e=t.parentElement;for(;e&&e!==this.folderTree;){if(e.classList.contains("folder-children")){e.style.display="block";const i=(r=e.previousElementSibling)==null?void 0:r.querySelector(".folder-toggle");i&&(i.textContent="â–¼")}e=e.parentElement}}findFolderById(t,e){for(const r of t){if(r.id===e)return r;if(r.children){const i=this.findFolderById(r.children,e);if(i)return i}}return null}findParentFolder(t,e,r=null){for(const i of t){if(i.id===e)return r;if(i.children){const o=this.findParentFolder(i.children,e,i);if(o!==null)return o}}return null}renderBookmarks(){const t=this.searchInput.value.trim();if(t){this.renderSearchResults(t);return}if(!this.currentFolder){this.bookmarkTree.innerHTML=`
        <div class="empty-state">
          <h3>é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹</h3>
          <p>ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹æ¥æŸ¥çœ‹å…¶ä¸­çš„ä¹¦ç­¾</p>
        </div>
      `;return}const e=this.findParentFolder(this.bookmarks,this.currentFolder.id);e?(this.backButton.style.display="flex",this.backButton.setAttribute("data-parent-id",e.id),this.backButton.querySelector(".back-text").textContent=`è¿”å› ${e.title}`):this.backButton.style.display="none";const r=this.findFolderById(this.bookmarks,this.currentFolder.id);if(!r){this.bookmarkTree.innerHTML=`
        <div class="empty-state">
          <h3>æ–‡ä»¶å¤¹ä¸å­˜åœ¨</h3>
          <p>æ­¤æ–‡ä»¶å¤¹å¯èƒ½å·²è¢«åˆ é™¤</p>
        </div>
      `;return}this.currentFolder=r;const i=this.currentFolder.children||[];if(i.length===0){this.bookmarkTree.innerHTML=`
        <div class="empty-state">
          <h3>æ–‡ä»¶å¤¹ä¸ºç©º</h3>
          <p>æ­¤æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰ä¹¦ç­¾</p>
        </div>
      `;return}let o=i;switch(this.currentFilter){case"visible":o=this.filterVisibleBookmarks(i);break;case"hidden":o=this.filterHiddenOnlyBookmarks(i);break;case"all":default:o=i;break}if(o.length===0){this.bookmarkTree.innerHTML=`
        <div class="empty-state">
          <h3>æ²¡æœ‰åŒ¹é…çš„ä¹¦ç­¾</h3>
          <p>å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰æ‰¾åˆ°ä¹¦ç­¾</p>
        </div>
      `;return}this.bookmarkTree.innerHTML=this.renderBookmarkList(o)}renderSearchResults(t){var o;const e=((o=this.bookmarks[0])==null?void 0:o.children)||[];let r=e;switch(this.currentFilter){case"visible":r=this.filterVisibleBookmarks(e);break;case"hidden":r=this.filterHiddenOnlyBookmarks(e);break;case"all":default:r=e;break}const i=this.searchInBookmarks(r,t.toLowerCase());if(i.length===0){this.bookmarkTree.innerHTML=`
        <div class="empty-state">
          <h3>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¹¦ç­¾</h3>
          <p>æœç´¢ "${t}" æ²¡æœ‰æ‰¾åˆ°ç»“æœ</p>
        </div>
      `,document.querySelectorAll(".folder-item").forEach(n=>{n.classList.remove("active")}),this.panelTitle.textContent="æœç´¢ç»“æœ";return}this.bookmarkTree.innerHTML=this.renderSearchResultsList(i,t),this.panelTitle.textContent=`æœç´¢ç»“æœ (${i.length} é¡¹)`,document.querySelectorAll(".folder-item").forEach(n=>{n.classList.remove("active")})}renderSearchResultsList(t,e){let r="";for(const i of t)if(i.url){const o=i.hidden||!1,n=o?" hidden-bookmark":"",s=o?"ğŸ‘ï¸â€ğŸ—¨ï¸":"",a=i.url.startsWith("javascript:"),d=i.url.startsWith("data:");let l,c,h;a||d?(l="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgMkgxNFYxNEgyVjJaIiBzdHJva2U9IiM2NjYiIHN0cm9rZS13aWR0aD0iMS41IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9Ik0yIDZIMTRWNkg2VjJaIiBmaWxsPSIjNjY2Ii8+Cjwvc3ZnPgo=",c="è„šæœ¬ä¹¦ç­¾",h=`data-script-url="${encodeURIComponent(i.url)}" class="script-bookmark"`):(l=this.getFaviconUrl(i.url),c=i.url,h=`href="${i.url}" target="_blank"`),r+=`
          <div class="bookmark-item${n}" data-bookmark-id="${i.id}" draggable="true">
            <div class="drag-handle">â‹®â‹®</div>
            <img class="bookmark-icon" src="${l}" alt="ä¹¦ç­¾" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgMkgxNFYxNEgyVjJaIiBzdHJva2U9IiM2NjYiIHN0cm9rZS13aWR0aD0iMS41IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9Ik0yIDZIMTRWNkg2VjJaIiBmaWxsPSIjNjY2Ii8+Cjwvc3ZnPgo='">
            <div class="bookmark-content">
              <a ${h} class="bookmark-title">${this.highlightSearchTerm(i.title,e)} ${s}</a>
              <div class="bookmark-url">${c}</div>
              <div class="bookmark-actions">
                <button class="action-btn action-btn-edit" data-bookmark-id="${i.id}">ç¼–è¾‘</button>
                <button class="action-btn action-btn-hide" data-bookmark-id="${i.id}">${o?"æ˜¾ç¤º":"éšè—"}</button>
                <button class="action-btn action-btn-delete" data-bookmark-id="${i.id}">åˆ é™¤</button>
              </div>
            </div>
          </div>
        `}else i.children&&(r+=this.renderSearchResultsList(i.children,e));return r}highlightSearchTerm(t,e){if(!e)return t;const r=new RegExp(`(${e})`,"gi");return t.replace(r,"<mark>$1</mark>")}renderSearchResultsInFolder(t,e){const r=this.searchInBookmarks(t.children||[],e.toLowerCase());if(r.length===0){this.bookmarkTree.innerHTML=`
        <div class="empty-state">
          <h3>è¯¥ç›®å½•ä¸­æ²¡æœ‰åŒ¹é…çš„ä¹¦ç­¾</h3>
          <p>åœ¨ "${t.title}" ä¸­æ²¡æœ‰æ‰¾åˆ°åŒ…å« "${e}" çš„ä¹¦ç­¾</p>
        </div>
      `,this.panelTitle.textContent=`${t.title} - æœç´¢ç»“æœ (0 é¡¹)`;return}this.bookmarkTree.innerHTML=this.renderSearchResultsList(r,e),this.panelTitle.textContent=`${t.title} - æœç´¢ç»“æœ (${r.length} é¡¹)`}renderBookmarkList(t){let e="";for(const r of t){const i=r.hidden||!1;if(r.url){const o=i?" hidden-bookmark":"",n=i?"ğŸ‘ï¸â€ğŸ—¨ï¸":"",s=r.url.startsWith("javascript:"),a=r.url.startsWith("data:");let d,l,c;s||a?(d="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgMkgxNFYxNEgyVjJaIiBzdHJva2U9IiM2NjYiIHN0cm9rZS13aWR0aD0iMS41IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9Ik0yIDZIMTRWNkg2VjJaIiBmaWxsPSIjNjY2Ii8+Cjwvc3ZnPgo=",l="è„šæœ¬ä¹¦ç­¾",c=`data-script-url="${encodeURIComponent(r.url)}" class="script-bookmark"`):(d=this.getFaviconUrl(r.url),l=r.url,c=`href="${r.url}" target="_blank"`),e+=`
          <div class="bookmark-item${o}" data-bookmark-id="${r.id}" draggable="true">
            <div class="drag-handle">â‹®â‹®</div>
            <img class="bookmark-icon" src="${d}" alt="ä¹¦ç­¾" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgMkgxNFYxNEgyVjJaIiBzdHJva2U9IiM2NjYiIHN0cm9rZS13aWR0aD0iMS41IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9Ik0yIDZIMTRWNkg2VjJaIiBmaWxsPSIjNjY2Ii8+Cjwvc3ZnPgo='">
            <div class="bookmark-content">
              <a ${c} class="bookmark-title">${r.title} ${n}</a>
              <div class="bookmark-url">${l}</div>
              <div class="bookmark-actions">
                <button class="action-btn action-btn-edit" data-bookmark-id="${r.id}">ç¼–è¾‘</button>
                <button class="action-btn action-btn-hide" data-bookmark-id="${r.id}">${i?"æ˜¾ç¤º":"éšè—"}</button>
                <button class="action-btn action-btn-delete" data-bookmark-id="${r.id}">åˆ é™¤</button>
              </div>
            </div>
          </div>
        `}else if(r.children){const o=i?" hidden-bookmark":"",n=i?"ğŸ‘ï¸â€ğŸ—¨ï¸":"";e+=`
          <div class="bookmark-item folder-item${o}" data-folder-id="${r.id}" data-bookmark-id="${r.id}" draggable="true">
            <div class="drag-handle">â‹®â‹®</div>
            <div class="folder-icon">ğŸ“</div>
            <div class="bookmark-content">
              <div class="bookmark-title">${r.title} ${n}</div>
              <div class="bookmark-url">æ–‡ä»¶å¤¹ (${r.children.length} é¡¹)</div>
              <div class="bookmark-actions">
                <button class="action-btn action-btn-edit" data-bookmark-id="${r.id}">ç¼–è¾‘</button>
                <button class="action-btn action-btn-hide" data-bookmark-id="${r.id}">${i?"æ˜¾ç¤º":"éšè—"}</button>
                <button class="action-btn action-btn-delete" data-bookmark-id="${r.id}">åˆ é™¤</button>
              </div>
            </div>
          </div>
        `}}return e}updateStats(){const t=this.calculateStats(this.bookmarks);document.getElementById("totalBookmarks").textContent=t.totalBookmarks,document.getElementById("totalFolders").textContent=t.totalFolders,document.getElementById("recentBookmarks").textContent=t.recentBookmarks}calculateStats(t){let e=0,r=0,i=0;const o=Date.now()-7*24*60*60*1e3,n=s=>{for(const a of s)a.children?(r++,n(a.children)):a.url&&(e++,a.dateAdded&&a.dateAdded>o&&i++)};return n(t),{totalBookmarks:e,totalFolders:r,recentBookmarks:i}}addBookmark(){const t=prompt("è¯·è¾“å…¥ä¹¦ç­¾æ ‡é¢˜:");if(!t)return;const e=prompt("è¯·è¾“å…¥ä¹¦ç­¾URL:");if(e)try{typeof chrome<"u"&&chrome.bookmarks?chrome.bookmarks.create({title:t,url:e},()=>{this.loadBookmarks().then(()=>{this.renderFolderTree(),this.renderBookmarks(),this.updateStats()})}):alert("ä¹¦ç­¾æ·»åŠ åŠŸèƒ½éœ€è¦æµè§ˆå™¨æ‰©å±•ç¯å¢ƒ")}catch{alert("æ·»åŠ ä¹¦ç­¾å¤±è´¥")}}editBookmark(t){alert("ç¼–è¾‘åŠŸèƒ½å¾…å®ç°")}deleteBookmark(t){if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹¦ç­¾å—ï¼Ÿ"))try{typeof chrome<"u"&&chrome.bookmarks?chrome.bookmarks.remove(t,()=>{this.loadBookmarks().then(()=>{this.renderFolderTree(),this.renderBookmarks(),this.updateStats()})}):alert("ä¹¦ç­¾åˆ é™¤åŠŸèƒ½éœ€è¦æµè§ˆå™¨æ‰©å±•ç¯å¢ƒ")}catch{alert("åˆ é™¤ä¹¦ç­¾å¤±è´¥")}}exportBookmarks(){const t=JSON.stringify(this.bookmarks,null,2),e=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(e),i=document.createElement("a");i.href=r,i.download="bookmarks.json",i.click(),URL.revokeObjectURL(r)}findBookmarkById(t){const e=r=>{for(const i of r){if(i.id===t)return i;if(i.children){const o=e(i.children);if(o)return o}}return null};return e(this.bookmarks)}toggleBookmarkVisibility(t){const e=this.findBookmarkById(t);e&&(e.hidden=!e.hidden,e.children&&e.children.length>0&&this.toggleFolderVisibility(e,e.hidden),this.saveBookmarkTreeToGitee(this.bookmarks),this.saveBookmarksToStorage(),this.updateSystemBookmarks(),this.renderFolderTree(),this.renderBookmarks(),this.updateStats())}toggleFolderVisibility(t,e){if(t.hidden=e,t.children&&t.children.length>0)for(const r of t.children)r.hidden=e,r.children&&r.children.length>0&&this.toggleFolderVisibility(r,e)}updateSystemBookmarks(){if(typeof chrome<"u"&&chrome.bookmarks){const t=this.filterVisibleBookmarks(this.bookmarks[0].children);this.removeAllBookmarks().then(()=>{this.createBookmarks(t,"1").then(()=>{})}).catch(e=>{})}}removeAllBookmarks(){return new Promise(t=>{chrome.bookmarks.getTree(e=>{var n;const r=((n=e[0])==null?void 0:n.children)||[];let i=[];r.forEach(s=>{s.children&&s.children.length&&s.children.forEach(a=>i.push(a.id))});let o=i.length;if(o===0)return t();i.forEach(s=>{chrome.bookmarks.removeTree(s,()=>{o--,o===0&&t()})})})})}filterVisibleBookmarks(t){return Array.isArray(t)?t.filter(e=>{if(!e||e.hidden===!0)return!1;if(e.children&&Array.isArray(e.children)){const r=this.filterVisibleBookmarks(e.children);if(r.length>0)e.children=r;else return!1}return!0}):[]}createBookmarks(t,e="1"){return!Array.isArray(t)||t.length===0?Promise.resolve():Promise.all(t.map(r=>r?r.url?new Promise(i=>{chrome.bookmarks.create({parentId:e,title:r.title,url:r.url},o=>{chrome.runtime.lastError,i(void 0)})}):new Promise(i=>{chrome.bookmarks.create({parentId:e,title:r.title},o=>{chrome.runtime.lastError?i(void 0):r.children&&r.children.length>0?this.createBookmarks(r.children,o.id).then(()=>i(void 0)):i(void 0)})}):Promise.resolve())).then(()=>{})}loadBookmarksFromGitee(){return new Promise((t,e)=>{if(!this.giteeConfig||!this.giteeConfig.owner||!this.giteeConfig.repo||!this.giteeConfig.token){e(new Error("Giteeé…ç½®ä¸å®Œæ•´"));return}const r=`https://gitee.com/api/v5/repos/${this.giteeConfig.owner}/${this.giteeConfig.repo}/contents/${this.giteeConfig.filePath}`;fetch(r,{method:"GET",headers:{Authorization:`token ${this.giteeConfig.token}`}}).then(i=>i.json()).then(i=>{if(i.content){const o=decodeURIComponent(escape(atob(i.content))),n=JSON.parse(o);t(n)}else e(new Error("æ— æ³•è·å–æ–‡ä»¶å†…å®¹"))}).catch(i=>{e(i)})})}filterHiddenBookmarks(t){const e=r=>r.filter(i=>i.hidden?!1:(i.children&&(i.children=e(i.children)),!0));return e(t)}filterVisibleBookmarks(t){const e=r=>r.filter(i=>{if(i.hidden)return!1;if(i.children){const o=e(i.children);return o.length>0?{...i,children:o}:!1}return!0});return e(t)}filterHiddenOnlyBookmarks(t){const e=r=>r.filter(i=>{if(i.hidden)return!0;if(i.children&&i.children.length>0){const o=e(i.children);return i.hidden||o.length>0?{...i,children:o}:!1}return!1});return e(t)}saveBookmarkTreeToGitee(t){if(!this.giteeConfig||!this.giteeConfig.owner||!this.giteeConfig.repo||!this.giteeConfig.token)return;const e=JSON.stringify(t,null,2),r=btoa(unescape(encodeURIComponent(e)));this.getFileSha().then(i=>{const o=`https://gitee.com/api/v5/repos/${this.giteeConfig.owner}/${this.giteeConfig.repo}/contents/${this.giteeConfig.filePath}`;fetch(o,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`token ${this.giteeConfig.token}`},body:JSON.stringify({message:"æ›´æ–°ä¹¦ç­¾æ ‘ - éšè—å±æ€§",content:r,sha:i})}).then(n=>n.json()).then(n=>{n.content}).catch(n=>{})})}async openDB(){return new Promise((t,e)=>{const r=indexedDB.open("bookmarks-plus",1);r.onupgradeneeded=function(i){const o=i.target.result;o.objectStoreNames.contains("gitee-config")||o.createObjectStore("gitee-config")},r.onsuccess=function(i){t(i.target.result)},r.onerror=function(i){e(i)}})}async getConfigFromIndexedDB(t){const e=await this.openDB();return new Promise(r=>{const o=e.transaction("gitee-config","readonly").objectStore("gitee-config"),n={};let s=t.length;t.forEach(a=>{const d=o.get(a);d.onsuccess=function(){n[a]=d.result||"",s--,s===0&&r(n)},d.onerror=function(){s--,s===0&&r(n)}})})}async setConfigToIndexedDB(t){const r=(await this.openDB()).transaction("gitee-config","readwrite"),i=r.objectStore("gitee-config");return Object.entries(t).forEach(([o,n])=>i.put(n,o)),new Promise(o=>{r.oncomplete=()=>o(),r.onerror=()=>o()})}async loadConfigFromIndexedDB(){const t=["giteeToken","giteeOwner","giteeRepo","giteeBranch","giteeFilePath"],e=await this.getConfigFromIndexedDB(t);this.giteeConfig.owner=e.giteeOwner||"",this.giteeConfig.repo=e.giteeRepo||"",this.giteeConfig.token=e.giteeToken||"",this.giteeConfig.branch=e.giteeBranch||"master",this.giteeConfig.filePath=e.giteeFilePath||"hidden-bookmarks.json"}async getFileSha(){try{const t=`https://gitee.com/api/v5/repos/${this.giteeConfig.owner}/${this.giteeConfig.repo}/contents/${this.giteeConfig.filePath}?ref=${this.giteeConfig.branch}`,e=await fetch(t,{headers:{Authorization:`token ${this.giteeConfig.token}`}});if(e.ok)return(await e.json()).sha}catch{}return null}showConfigModal(){const t=document.getElementById("configModal");t.style.display="flex",document.getElementById("giteeOwner").value=this.giteeConfig.owner,document.getElementById("giteeRepo").value=this.giteeConfig.repo,document.getElementById("giteeToken").value=this.giteeConfig.token}hideConfigModal(){const t=document.getElementById("configModal");t.style.display="none"}async saveConfig(){const t=document.getElementById("giteeOwner").value.trim(),e=document.getElementById("giteeRepo").value.trim(),r=document.getElementById("giteeToken").value.trim();if(!t||!e||!r){alert("è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯");return}this.giteeConfig.owner=t,this.giteeConfig.repo=e,this.giteeConfig.token=r;try{await this.setConfigToIndexedDB({giteeOwner:t,giteeRepo:e,giteeToken:r,giteeBranch:this.giteeConfig.branch,giteeFilePath:this.giteeConfig.filePath})}catch{}this.hideConfigModal(),alert("é…ç½®å·²ä¿å­˜ï¼")}}document.addEventListener("DOMContentLoaded",()=>{window.bookmarkManager=new f});
